<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="light"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title> &middot; welcome</title>
  <meta name="title" content=" &middot; welcome" />
  
  
  
  
  
  <link rel="canonical" href="https://Wboyue.github.io/notebook/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.f45ab567066571a138e005c4bc8ab3cdd16644275739c29e1fe97e10c67b3579d18cf90f9b6db688b3af9263efc08d4762c419fe14d61e3c2c28d55e8eac99ec.css"
    integrity="sha512-9Fq1ZwZlcaE44AXEvIqzzdFmRCdXOcKeH&#43;l&#43;EMZ7NXnRjPkPm222iLOvkmPvwI1HYsQZ/hTWHjwsKNVejqyZ7A==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.3f354537071ffde8a37d7f5b5eb0fea76345387a132a0c386682cae063b66ebb6285757ca88352be474056280043b16f4f53986014c1f818a9aabf17220ae601.js"
    integrity="sha512-PzVFNwcf/eijfX9bXrD&#43;p2NFOHoTKgw4ZoLK4GO2brtihXV8qINSvkdAVigAQ7FvT1OYYBTB&#43;Bipqr8XIgrmAQ==" data-copy="" data-copied=""></script>
  
  
  <script src="/js/zoom.min.js"></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:url" content="https://Wboyue.github.io/notebook/">
  <meta property="og:site_name" content="welcome">
  <meta property="og:title" content="welcome">
  <meta property="og:description" content="卷积神经网络加速器设计——吴帛樾 #[TOC]
创新点：
part1.轻量级的网络结构&amp;mdash;-网络性能对比
part2.4bit量化，cnn加速器
python #import #Python 的 import 语句在搜索模块时会遵循一定的顺序和规则，具体如下：
内置模块: Python 会首先搜索内置模块，这些模块是与 Python 解释器一起发布的，并且位于 Python 安装目录下的 Lib 文件夹中。
sys.path 路径: Python 解释器会搜索 sys.path 中列出的路径。这个列表包括以下几个位置：
环境变量 PYTHONPATH 指定的路径。 当前目录（即运行脚本所在的目录）。 标准库目录。 其他用户自定义的目录。 site-packages 目录: 这个目录是 Python 安装时默认创建的，用于存放第三方库和模块。Python 会搜索该目录以导入已安装的第三方模块。
综上所述，当你在 Python 中使用 import 语句导入模块时，Python 解释器会按照上述规则依次搜索模块，找到第一个匹配的模块并导入它。如果在所有位置都找不到指定的模块，则会引发 ImportError 异常。
self.lib #self.lib是一个Python对象,它指向一个已经加载到内存中的C共享库(shared library)。
在这个上下文中,self是指当前类的实例,而lib是该实例的一个属性。当执行了某些初始化操作加载C共享库之后,该库的句柄就被存储在了self.lib属性中。
在大多数情况下,self.lib通过以下步骤获得:
使用cffi库加载一个C共享库文件(通常扩展名为.so或.dll)。这一步会返回一个库句柄对象。
这个库句柄对象被赋值给当前类实例的lib属性,即self.lib = 库句柄。
加载完共享库后,就可以通过self.lib属性访问该库中暴露的函数和符号。比如self.lib.singleInference就是指向共享库中名为singleInference的函数。
使用cffi加载C库的典型做法是:
import cffi ffilib = cffi.FFI() ffilib.cdef(&amp;#34;&amp;#34;&amp;#34; // C函数声明 &amp;#34;&amp;#34;&amp;#34;) self.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
  <meta property="article:section" content="">

  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="">
<meta name="twitter:description" content="卷积神经网络加速器设计——吴帛樾 #[TOC]
创新点：
part1.轻量级的网络结构&mdash;-网络性能对比
part2.4bit量化，cnn加速器
python #import #Python 的 import 语句在搜索模块时会遵循一定的顺序和规则，具体如下：
内置模块: Python 会首先搜索内置模块，这些模块是与 Python 解释器一起发布的，并且位于 Python 安装目录下的 Lib 文件夹中。
sys.path 路径: Python 解释器会搜索 sys.path 中列出的路径。这个列表包括以下几个位置：
环境变量 PYTHONPATH 指定的路径。 当前目录（即运行脚本所在的目录）。 标准库目录。 其他用户自定义的目录。 site-packages 目录: 这个目录是 Python 安装时默认创建的，用于存放第三方库和模块。Python 会搜索该目录以导入已安装的第三方模块。
综上所述，当你在 Python 中使用 import 语句导入模块时，Python 解释器会按照上述规则依次搜索模块，找到第一个匹配的模块并导入它。如果在所有位置都找不到指定的模块，则会引发 ImportError 异常。
self.lib #self.lib是一个Python对象,它指向一个已经加载到内存中的C共享库(shared library)。
在这个上下文中,self是指当前类的实例,而lib是该实例的一个属性。当执行了某些初始化操作加载C共享库之后,该库的句柄就被存储在了self.lib属性中。
在大多数情况下,self.lib通过以下步骤获得:
使用cffi库加载一个C共享库文件(通常扩展名为.so或.dll)。这一步会返回一个库句柄对象。
这个库句柄对象被赋值给当前类实例的lib属性,即self.lib = 库句柄。
加载完共享库后,就可以通过self.lib属性访问该库中暴露的函数和符号。比如self.lib.singleInference就是指向共享库中名为singleInference的函数。
使用cffi加载C库的典型做法是:
import cffi ffilib = cffi.FFI() ffilib.cdef(&#34;&#34;&#34; // C函数声明 &#34;&#34;&#34;) self.">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "welcome",
    "name": "",
    "headline": "",
    
    "abstract": "卷积神经网络加速器设计——吴帛樾 #\r[TOC]\n创新点：\npart1.轻量级的网络结构\u0026mdash;-网络性能对比\npart2.4bit量化，cnn加速器\npython #\rimport #\rPython 的 import 语句在搜索模块时会遵循一定的顺序和规则，具体如下：\n内置模块: Python 会首先搜索内置模块，这些模块是与 Python 解释器一起发布的，并且位于 Python 安装目录下的 Lib 文件夹中。\nsys.path 路径: Python 解释器会搜索 sys.path 中列出的路径。这个列表包括以下几个位置：\n环境变量 PYTHONPATH 指定的路径。 当前目录（即运行脚本所在的目录）。 标准库目录。 其他用户自定义的目录。 site-packages 目录: 这个目录是 Python 安装时默认创建的，用于存放第三方库和模块。Python 会搜索该目录以导入已安装的第三方模块。\n综上所述，当你在 Python 中使用 import 语句导入模块时，Python 解释器会按照上述规则依次搜索模块，找到第一个匹配的模块并导入它。如果在所有位置都找不到指定的模块，则会引发 ImportError 异常。\nself.lib #\rself.lib是一个Python对象,它指向一个已经加载到内存中的C共享库(shared library)。\n在这个上下文中,self是指当前类的实例,而lib是该实例的一个属性。当执行了某些初始化操作加载C共享库之后,该库的句柄就被存储在了self.lib属性中。\n在大多数情况下,self.lib通过以下步骤获得:\n使用cffi库加载一个C共享库文件(通常扩展名为.so或.dll)。这一步会返回一个库句柄对象。\n这个库句柄对象被赋值给当前类实例的lib属性,即self.lib = 库句柄。\n加载完共享库后,就可以通过self.lib属性访问该库中暴露的函数和符号。比如self.lib.singleInference就是指向共享库中名为singleInference的函数。\n使用cffi加载C库的典型做法是:\nimport cffi ffilib = cffi.FFI() ffilib.cdef(\u0026#34;\u0026#34;\u0026#34; \/\/ C函数声明 \u0026#34;\u0026#34;\u0026#34;) self.",
    "inLanguage": "en",
    "url" : "https:\/\/Wboyue.github.io\/notebook\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "3928"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.js" integrity=""></script>





















  
  


  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">welcome</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
             
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a  class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="">
      Parent
    </a>
    <span>
      

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
        <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            sub-menu 1
          </p>
        </a>
        
        <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            sub-menu 2
          </p>
        </a>
        
        <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <span  class="mr-1" >
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


          </span>
          
          <p class="text-sm font-sm" title="">
            sub-menu 3
          </p>
        </a>
        
      </div>
    </div>
  </div>
</div>



            
            
  <a href="https://github.com/Wboyue"  target="_blank"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <span >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


    </span>
    
    <p class="text-base font-medium" title="">
        
    </p>
</a>


            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" for="menu-controller" class="block">
            <input type="checkbox" id="menu-controller" class="hidden" />
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li>
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                     
  <li class="mt-1">
    <a class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Parent
        </p>
        <span>
            

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


        </span>
    </a>
</li>

<li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            sub-menu 1
        </p>
    </a>
</li>

<li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            sub-menu 2
        </p>
    </a>
</li>

<li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <span  class="mr-1" >
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


        </span>
        
        <p class="text-sm font-small" title="">
            sub-menu 3
        </p>
    </a>
</li>

<li class="mb-2"></li>



                    

                    
  <li class="mt-1">
    <a href="https://github.com/Wboyue"  target="_blank"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <div >
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


        </div>
        
        <p class="text-bg font-bg" title="">
            
        </p>
    </a>
</li>



                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span>3928 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">19 mins</span>
  

  
  
</div>







    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">卷积神经网络加速器设计——吴帛樾 
    <div id="%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F%E5%99%A8%E8%AE%BE%E8%AE%A1%E5%90%B4%E5%B8%9B%E6%A8%BE" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F%E5%99%A8%E8%AE%BE%E8%AE%A1%E5%90%B4%E5%B8%9B%E6%A8%BE" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>[TOC]</p>
<div style="page-break-after:always"></div>
<p>创新点：</p>
<p>part1.轻量级的网络结构&mdash;-网络性能对比</p>
<p>part2.4bit量化，cnn加速器</p>


<h2 class="relative group">python 
    <div id="python" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#python" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h3 class="relative group">import 
    <div id="import" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#import" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Python 的 import 语句在搜索模块时会遵循一定的顺序和规则，具体如下：</p>
<ol>
<li>
<p><strong>内置模块</strong>: Python 会首先搜索内置模块，这些模块是与 Python 解释器一起发布的，并且位于 Python 安装目录下的 Lib 文件夹中。</p>
</li>
<li>
<p><strong>sys.path 路径</strong>: Python 解释器会搜索 sys.path 中列出的路径。这个列表包括以下几个位置：</p>
<ul>
<li>环境变量 PYTHONPATH 指定的路径。</li>
<li>当前目录（即运行脚本所在的目录）。</li>
<li>标准库目录。</li>
<li>其他用户自定义的目录。</li>
</ul>
</li>
<li>
<p><strong>site-packages 目录</strong>: 这个目录是 Python 安装时默认创建的，用于存放第三方库和模块。Python 会搜索该目录以导入已安装的第三方模块。</p>
</li>
</ol>
<p>综上所述，当你在 Python 中使用 import 语句导入模块时，Python 解释器会按照上述规则依次搜索模块，找到第一个匹配的模块并导入它。如果在所有位置都找不到指定的模块，则会引发 ImportError 异常。</p>


<h3 class="relative group">self.lib 
    <div id="selflib" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#selflib" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p><code>self.lib</code>是一个Python对象,它指向一个已经加载到内存中的C共享库(shared library)。</p>
<p>在这个上下文中,<code>self</code>是指当前类的实例,而<code>lib</code>是该实例的一个属性。当执行了某些初始化操作加载C共享库之后,该库的句柄就被存储在了<code>self.lib</code>属性中。</p>
<p>在大多数情况下,<code>self.lib</code>通过以下步骤获得:</p>
<ol>
<li>
<p>使用<code>cffi</code>库加载一个C共享库文件(通常扩展名为<code>.so</code>或<code>.dll</code>)。这一步会返回一个库句柄对象。</p>
</li>
<li>
<p>这个库句柄对象被赋值给当前类实例的<code>lib</code>属性,即<code>self.lib = 库句柄</code>。</p>
</li>
</ol>
<p>加载完共享库后,就可以通过<code>self.lib</code>属性访问该库中暴露的函数和符号。比如<code>self.lib.singleInference</code>就是指向共享库中名为<code>singleInference</code>的函数。</p>
<p>使用<code>cffi</code>加载C库的典型做法是:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">cffi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ffilib</span> <span class="o">=</span> <span class="n">cffi</span><span class="o">.</span><span class="n">FFI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ffilib</span><span class="o">.</span><span class="n">cdef</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">   // C函数声明
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">ffilib</span><span class="o">.</span><span class="n">dlopen</span><span class="p">(</span><span class="s2">&#34;path/to/library.so&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>这样就可以在Python代码中方便地调用C函数,同时利用NumPy数组与C数据的无缝交换。<code>self.lib</code>属性使得Python代码能够像使用标准库一样,方便地访问C共享库中的接口。</p>
<p>总之,<code>self.lib</code>代表了一个已加载的C共享库的句柄,是Python调用C函数并执行底层硬件加速等操作的重要入口。</p>


<h2 class="relative group">Pytorch 
    <div id="pytorch" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#pytorch" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p><a href="https://pytorch.org/"   target="_blank">
    https://pytorch.org/</a></p>
<p><a href="https://pytorch.org/tutorials/"   target="_blank">
    https://pytorch.org/tutorials/</a></p>


<h2 class="relative group">网络架构选择与修改 
    <div id="%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E9%80%89%E6%8B%A9%E4%B8%8E%E4%BF%AE%E6%94%B9" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E9%80%89%E6%8B%A9%E4%B8%8E%E4%BF%AE%E6%94%B9" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>为移动端部署目标检测模型确实需要考虑模型的尺寸和计算复杂度。以下是一些比较流行的轻量级目标检测卷积神经网络:</p>
<ol>
<li>
<p><strong>YOLO系列</strong>:</p>
<ul>
<li>YOLOv5: <a href="https://github.com/ultralytics/yolov5"   target="_blank">
    https://github.com/ultralytics/yolov5</a></li>
<li>YOLOv4: <a href="https://github.com/AlexeyAB/darknet"   target="_blank">
    https://github.com/AlexeyAB/darknet</a>
YOLO系列模型在保持较高精度的同时,模型尺寸和计算复杂度相对较低,适合移动端部署。</li>
</ul>
</li>
<li>
<p><strong>SSD (单Shot多框检测器)</strong>:</p>
<ul>
<li>MobileNetSSD: <a href="https://github.com/chuanqi305/MobileNetSSD"   target="_blank">
    https://github.com/chuanqi305/MobileNetSSD</a></li>
<li>RFSoD: <a href="https://github.com/songjianPI/RFSoD"   target="_blank">
    https://github.com/songjianPI/RFSoD</a>
这些模型基于移动设备优化的MobileNet骨干网络,模型尺寸小,运算效率较高。</li>
</ul>
</li>
<li>
<p><strong>EfficientDet</strong>:</p>
<ul>
<li>EfficientDet-Lite: <a href="https://github.com/google/automl/tree/master/efficientdet"   target="_blank">
    https://github.com/google/automl/tree/master/efficientdet</a>
EfficientDet系列是Google开源的一系列高效目标检测模型,其中EfficientDet-Lite专门针对移动设备优化。</li>
</ul>
</li>
<li>
<p><strong>FCOS (全卷积单阶段物体检测)</strong>:</p>
<ul>
<li>Ultralight FCOS: <a href="https://github.com/ReighBay/Ultralight-FCOS"   target="_blank">
    https://github.com/ReighBay/Ultralight-FCOS</a>
基于FCOS设计的Ultralight FCOS通过模型压缩和网路设计加速,在保持较高精度的同时显著降低了模型尺寸和计算量。</li>
</ul>
</li>
</ol>
<p>这些模型通过特定的网络设计、模型压缩等策略达到了在移动设备上的高效部署,但其中也存在一定的权衡,需要根据具体场景的精度和速度要求进行选择。</p>
<p>注意力机制(Attention Mechanism)是深度学习领域中一种重要的技术,它通过计算一个输入序列中不同位置的元素对输出的重要程度,从而学会更好地关注对预测任务有用的部分。</p>
<p>注意力机制最早被应用于机器翻译任务中,后来也广泛用于计算机视觉、自然语言处理等领域。主要思想是在计算输出时,对不同位置的输入赋予不同的权重,使模型能够专注于更重要的部分。</p>
<p>注意力机制主要包括以下几个步骤:</p>
<ol>
<li><strong>获取查询(Query)向量和键(Keys)向量</strong>:查询向量代表当前状态,键向量代表要关注的输入序列。</li>
<li><strong>计算注意力分数(Attention Scores)</strong>:通过某种方法(如点乘或加性)计算查询向量与所有键向量的相似性分数。</li>
<li><strong>归一化注意力分数</strong>:对注意力分数进行归一化处理(如softmax),得到注意力权重。</li>
<li><strong>加权求和</strong>:使用注意力权重对值向量(Value Vectors)进行加权求和,得到最终的输出向量。</li>
</ol>
<p>不同类型的注意力机制主要区别在于计算注意力分数的方法和输入表示的方式上。一些常见的注意力机制包括:</p>
<ul>
<li><strong>加性注意力(Additive Attention)</strong>:计算查询和键之间的加性相似性。</li>
<li><strong>点乘注意力(Dot-Product Attention)</strong>:计算查询和键向量的点乘作为相似性分数(如Transformer中的multi-head注意力)。</li>
<li><strong>多头注意力(Multi-Head Attention)</strong>:允许注意力机制从不同的子空间获取信息。</li>
<li><strong>自注意力(Self-Attention)</strong>:查询、键、值向量来自同一个输入序列,常用于捕获长距离依赖关系。</li>
</ul>
<p>注意力机制通过动态关注输入中对预测任务更有用的部分,显著提高了深度学习模型在各种任务上的性能,是目前许多优秀模型的关键技术之一。</p>
<p>除了注意力机制之外,还有一些其他有用的机制被广泛应用于目标检测任务中,以提高检测性能。以下是一些常用的机制:</p>
<ol>
<li><strong>锚框(Anchor Boxes)</strong> 锚框机制将图像划分为多个区域,对每个区域生成多个预先设定形状和比例的锚框,然后根据锚框与真实边界框的重合程度预测目标。这种机制常用于一阶段目标检测器,如Faster R-CNN。</li>
<li><strong>特征金字塔(Feature Pyramid Networks, FPN)</strong> FPN融合了不同尺度的特征图,使用横向连接融合高层语义特征和底层细节特征,增强了目标检测在不同尺度上的能力。</li>
<li><strong>先验框回归(Bounding Box Regression)</strong> 通过回归预测一个先验框与真实边界框的偏移量,从而精细修正先验框的位置和尺寸,提高目标定位的精度。</li>
<li><strong>非极大值抑制(Non-Maximum Suppression, NMS)</strong> NMS通过消除重叠目标框,留下置信度最高的那些框,从而去除重复检测的结果。</li>
<li><strong>上下文增强(Context Enhancement)</strong> 利用目标周围区域的上下文信息去增强目标特征表示,提高小目标和遮挡目标的检测性能。</li>
<li><strong>学习隔离表示(Learnable Embedding Representation)</strong> 通过学习像素级的语义嵌入表示,提高对目标的识别和检测。</li>
<li><strong>数据增广(Data Augmentation)</strong> 使用各种图像变换手段(翻转、裁剪、扭曲等)在训练时生成更多不同的样本,增强模型的泛化性能。</li>
<li><strong>级联结构(Cascade Structure)</strong> 采用多阶段级联机制,使得每个阶段的分类器和回归器都可以专注于比上个阶段更难但范围更小的样本区域,提高检测准确率。</li>
</ol>
<p>这些机制可以单独或组合使用,并针对不同的目标检测任务有优化和调整。通过引入这些机制,目标检测模型可以获得更好的检测精度和鲁棒性。</p>
<p>对于识别不同类型的血细胞,一些常用的深度学习网络包括:</p>
<ol>
<li>卷积神经网络(CNN)
<ul>
<li>CNN擅长从图像中提取特征,可以用于血细胞图像分类任务。典型的网络如AlexNet、VGGNet、ResNet等都可以应用于此问题。</li>
<li>可以考虑使用较浅层的CNN,如LeNet等,因为血细胞图像相对简单,无需过于深层的网络。</li>
</ul>
</li>
<li>全卷积网络(FCN)
<ul>
<li>FCN无需将输入图像固定尺寸,可以对任意尺寸输入进行分割和像素级分类。</li>
<li>适合血细胞检测和分割任务,可以同时识别和定位不同类型的细胞。</li>
</ul>
</li>
<li>U-Net
<ul>
<li>U-Net是一种常用的医学图像分割网络,具有编码器-解码器结构。</li>
<li>通过跳跃连接融合不同尺度特征,效果好,常用于血细胞等细粒度对象分割。</li>
</ul>
</li>
<li>Mask R-CNN
<ul>
<li>基于Faster R-CNN的实例分割网络,可同时实现目标检测和像素级分割。</li>
<li>适合同时检测和分类不同类型的细胞。</li>
</ul>
</li>
<li>小型网络
<ul>
<li>如MobileNet、SqueezeNet等,计算量小,适合移动端和嵌入式应用场景部署。</li>
<li>可用于快速血细胞分类,满足低功耗和实时性要求。</li>
</ul>
</li>
</ol>
<p>在使用这些网络时,数据预处理、数据增强、正则化、细调超参数等都是非常重要的。此外医学影像往往数据量较小,可以考虑迁移学习等方法来提升性能。具体选择哪种网络,需要权衡精度、速度和部署环境的需求。</p>
<p>在资源受限环针对血细胞识别这一具体任务,有以下几种方式可以提高网络的性能:</p>
<ol>
<li><strong>数据增强</strong> 由于医疗图像数据通常较为稀缺,因此可以通过数据增强的方式扩充训练集,常用的数据增强操作包括旋转、翻转、缩放、裁剪、噪声添加等。这有助于提高模型的泛化能力。</li>
<li><strong>微调预训练模型</strong> 在医疗图像数据集上从头训练模型需要大量数据,一种可行方式是利用在大型数据集(如ImageNet)上预训练的模型,通过微调的方式将其迁移到医疗任务上。这可以极大缩短收敛时间并提高性能。</li>
<li><strong>集成学习</strong> 将多个不同模型的预测结果集成,可以显著提升性能。常用的集成方法包括Bagging、Boosting、投票等。对于不同的预测模型,也可以考虑级联或加权平均的方式进行融合。</li>
<li><strong>注意力机制</strong> 引入注意力机制有助于模型学习聚焦图像的关键区域,对细胞类型的识别非常有帮助,例如可以使用SENet或非局部模块等。</li>
<li><strong>体系结构改进</strong> 根据任务特点对网络架构进行改进,如采用U-Net的编码器-解码器结构、加入空洞卷积等操作,以提取更加有效的特征。</li>
<li><strong>优化器和损失函数</strong> 选择合适的优化器(如Adam)和损失函数(交叉熵、Focal Loss等)对模型训练也很重要。</li>
<li><strong>硬件加速</strong> 充分利用GPU、TPU等加速硬件,可以大幅提高模型训练和部署的效率。</li>
<li><strong>人工干预</strong> 人工引导和修正模型识别结果,也是医疗领域常用的手段,可以构建交互式识别系统。</li>
</ol>
<p>综上所述,通过数据增强、模型微调和集成、注意力机制等多管齐下,结合领域知识对网络进行优化和改造,可以有效提高血细胞识别的性能。</p>
<p>境如移动端或嵌入式设备中,通常需要一些小型化的目标检测模型,以权衡模型大小、计算量和检测精度。以下是一些常用的小型目标检测网络:</p>
<ol>
<li>
<p>YOLO 系列</p>
<p>:</p>
<ul>
<li>YOLOv4-Tiny: 小型版本的 YOLOv4 网络,只有 6.9M 参数。</li>
<li>YOLOv5s: YOLOv5 中最小的版本,参数量 7.5M。</li>
</ul>
</li>
<li>
<p>SSD 系列</p>
<p>:</p>
<ul>
<li>MobileNet-SSD: 采用 MobileNet 作为主干网络,具有很小的模型尺寸(6M 左右)。</li>
<li>SqueezeNet-SSD: 基于 SqueezeNet 的轻量级 SSD 网络。</li>
</ul>
</li>
<li>
<p>单级检测器</p>
<p>:</p>
<ul>
<li>Single Shot MultiBox Detector (SSD)</li>
<li>RetinaNet</li>
</ul>
</li>
<li>
<p>Two-Stage 检测器</p>
<p>:</p>
<ul>
<li>Faster R-CNN (Tiny Versions)</li>
<li>FCOS (Fully Convolutional One-Stage Object Detection)</li>
</ul>
</li>
<li>
<p>特定领域优化网络</p>
<p>:</p>
<ul>
<li>PVANET: 专为人体检测而设计的小型网络。</li>
<li>M2Det: 针对工业上的小型缺陷检测任务。</li>
</ul>
</li>
<li>
<p>基于 MobileNet / ShuffleNet 的检测网络</p>
<p>:</p>
<ul>
<li>MobileNetV3-SSD / ShuffleNetV2-SSD</li>
<li>MnasFPN (Neural Architecture Search)</li>
</ul>
</li>
</ol>
<p>这些网络一般都在 1M~10M 参数量的范围内,通过模型压缩、网络设计等策略达到了较小的模型尺寸和计算量,可以在资源受限环境下实现实时的目标检测。但它们也存在一定的精度损失,需要根据应用场景的具体要求进行权衡选择。</p>


<h2 class="relative group">2015 
    <div id="2015" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#2015" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h3 class="relative group">全卷积网络(Fully Convolutional Networks, FCN) 
    <div id="%E5%85%A8%E5%8D%B7%E7%A7%AF%E7%BD%91%E7%BB%9Cfully-convolutional-networks-fcn" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%85%A8%E5%8D%B7%E7%A7%AF%E7%BD%91%E7%BB%9Cfully-convolutional-networks-fcn" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>FCN模型最早发表于2015年的论文《Fully Convolutional Networks for Semantic Segmentation》,该论文由加州大学伯克利分校的Jonathan Long、Evan Shelhamer、Trevor Darrell等人撰写,发表于IEEE计算机协会的计算机视觉与模式识别(CVPR)顶级会议。</p>
<p>将现有的卷积神经网络改造成全卷积的结构,可以接受任意尺寸的输入图像,并对每个像素点输出对应的预测结果,从而可用于语义分割任务。</p>
<p>创新点：</p>
<p>1、将全连接层转化为卷积层,接受任意大小输入。</p>
<p>2、使用反卷积层进行上采样,获得与输入分辨率相同的输出。</p>
<p>3、增加跳级结构,融合多尺度特征信息。</p>
<p>很多后续工作如U-Net、DeepLab等都是基于FCN提出的创新思路发展而来。因此,FCN可以说是计算机视觉语义分割发展史上具有里程碑意义的工作。</p>


<h3 class="relative group">快速降采样 
    <div id="%E5%BF%AB%E9%80%9F%E9%99%8D%E9%87%87%E6%A0%B7" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%BF%AB%E9%80%9F%E9%99%8D%E9%87%87%E6%A0%B7" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h3 class="relative group">VGG16 
    <div id="vgg16" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vgg16" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<blockquote>
<p><a href="https://blog.csdn.net/qq_59572329/article/details/122143301"   target="_blank">
    https://blog.csdn.net/qq_59572329/article/details/122143301</a></p>
</blockquote>
<center>
<img src="./img/20200824152348459.png" width="800"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>


<h3 class="relative group">YOLOv5 
    <div id="yolov5" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#yolov5" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<blockquote>
<p><a href="https://github.com/ultralytics/yolov5"   target="_blank">
    https://github.com/ultralytics/yolov5</a></p>
<p><a href="https://docs.ultralytics.com/zh/yolov5/"   target="_blank">
    https://docs.ultralytics.com/zh/yolov5/</a></p>
</blockquote>
<center>
<img src="./img/屏幕截图 2024-04-02 103604.png" width="1500"/>
</center>
<center>
<font size=2 >
Figure.
</font>
</center>
<p>关于YOLOv5网络结构：</p>
<blockquote>
<p><a href="https://blog.csdn.net/qq_52358401/article/details/137005496"   target="_blank">
    https://blog.csdn.net/qq_52358401/article/details/137005496</a></p>
</blockquote>
<p>对于识别不同类型的血细胞,一些常用的深度学习网络包括:</p>
<ol>
<li>卷积神经网络(CNN)
<ul>
<li>CNN擅长从图像中提取特征,可以用于血细胞图像分类任务。典型的网络如AlexNet、VGGNet、ResNet等都可以应用于此问题。</li>
<li>可以考虑使用较浅层的CNN,如LeNet等,因为血细胞图像相对简单,无需过于深层的网络。</li>
</ul>
</li>
<li>全卷积网络(FCN)
<ul>
<li>FCN无需将输入图像固定尺寸,可以对任意尺寸输入进行分割和像素级分类。</li>
<li>适合血细胞检测和分割任务,可以同时识别和定位不同类型的细胞。</li>
</ul>
</li>
<li>U-Net
<ul>
<li>U-Net是一种常用的医学图像分割网络,具有编码器-解码器结构。</li>
<li>通过跳跃连接融合不同尺度特征,效果好,常用于血细胞等细粒度对象分割。</li>
</ul>
</li>
<li>Mask R-CNN
<ul>
<li>基于Faster R-CNN的实例分割网络,可同时实现目标检测和像素级分割。</li>
<li>适合同时检测和分类不同类型的细胞。</li>
</ul>
</li>
<li>小型网络
<ul>
<li>如MobileNet、SqueezeNet等,计算量小,适合移动端和嵌入式应用场景部署。</li>
<li>可用于快速血细胞分类,满足低功耗和实时性要求。</li>
</ul>
</li>
</ol>
<p>在使用这些网络时,数据预处理、数据增强、正则化、细调超参数等都是非常重要的。此外医学影像往往数据量较小,可以考虑迁移学习等方法来提升性能。具体选择哪种网络,需要权衡精度、速度和部署环境的需求。</p>
<p>针对血细胞识别这一具体任务,有以下几种方式可以提高网络的性能:</p>
<ol>
<li><strong>数据增强</strong> 由于医疗图像数据通常较为稀缺,因此可以通过数据增强的方式扩充训练集,常用的数据增强操作包括旋转、翻转、缩放、裁剪、噪声添加等。这有助于提高模型的泛化能力。</li>
<li><strong>微调预训练模型</strong> 在医疗图像数据集上从头训练模型需要大量数据,一种可行方式是利用在大型数据集(如ImageNet)上预训练的模型,通过微调的方式将其迁移到医疗任务上。这可以极大缩短收敛时间并提高性能。</li>
<li><strong>集成学习</strong> 将多个不同模型的预测结果集成,可以显著提升性能。常用的集成方法包括Bagging、Boosting、投票等。对于不同的预测模型,也可以考虑级联或加权平均的方式进行融合。</li>
<li><strong>注意力机制</strong> 引入注意力机制有助于模型学习聚焦图像的关键区域,对细胞类型的识别非常有帮助,例如可以使用SENet或非局部模块等。</li>
<li><strong>体系结构改进</strong> 根据任务特点对网络架构进行改进,如采用U-Net的编码器-解码器结构、加入空洞卷积等操作,以提取更加有效的特征。</li>
<li><strong>优化器和损失函数</strong> 选择合适的优化器(如Adam)和损失函数(交叉熵、Focal Loss等)对模型训练也很重要。</li>
<li><strong>硬件加速</strong> 充分利用GPU、TPU等加速硬件,可以大幅提高模型训练和部署的效率。</li>
<li><strong>人工干预</strong> 人工引导和修正模型识别结果,也是医疗领域常用的手段,可以构建交互式识别系统。</li>
</ol>
<p>综上所述,通过数据增强、模型微调和集成、注意力机制等多管齐下,结合领域知识对网络进行优化和改造,可以有效提高血细胞识别的性能。</p>


<h3 class="relative group">8bit\4bit\2bit量化 
    <div id="8bit4bit2bit%E9%87%8F%E5%8C%96" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#8bit4bit2bit%E9%87%8F%E5%8C%96" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h3 class="relative group">空洞思想 
    <div id="%E7%A9%BA%E6%B4%9E%E6%80%9D%E6%83%B3" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%A9%BA%E6%B4%9E%E6%80%9D%E6%83%B3" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h2 class="relative group">性能指标 
    <div id="%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h2 class="relative group">图像与权重数据的转换 
    <div id="%E5%9B%BE%E5%83%8F%E4%B8%8E%E6%9D%83%E9%87%8D%E6%95%B0%E6%8D%AE%E7%9A%84%E8%BD%AC%E6%8D%A2" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%9B%BE%E5%83%8F%E4%B8%8E%E6%9D%83%E9%87%8D%E6%95%B0%E6%8D%AE%E7%9A%84%E8%BD%AC%E6%8D%A2" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h2 class="relative group">IP设计与验证 
    <div id="ip%E8%AE%BE%E8%AE%A1%E4%B8%8E%E9%AA%8C%E8%AF%81" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ip%E8%AE%BE%E8%AE%A1%E4%B8%8E%E9%AA%8C%E8%AF%81" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h3 class="relative group">整体架构 
    <div id="%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>在FPGA中部署神经网络，搭建一个完整的推理架构主要有两种设计范式：<strong>全流式</strong>和<strong>脉动整列</strong><sup>[1]</sup>。</p>
<p>具有本地存储能力的ALU通常也被称为计算单元PE。空域计算架构的加速器采用数据流控制，PE之间的数据可以流动传输。形成了一种处理链关系。在卷积神经网络加速中，空域计算架构显然更能胜任矩阵、张量的计算。因为空域计算架构提供了数据高度复用的可能，同时还能够充分利用内存带宽，从而缓解了带宽压力与访存量，因此加速器可以减少数据的传输次数，以更低的功耗、更高的能效运行，性能瓶颈也得以释放。</p>


<h3 class="relative group">数据流介绍 
    <div id="%E6%95%B0%E6%8D%AE%E6%B5%81%E4%BB%8B%E7%BB%8D" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E4%BB%8B%E7%BB%8D" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>深度神经网络加速器架构所采用的数据流中，主流的有输出固定（Output Stationary，OS）数据流、权重固定（Weight Stationary，WS）数据流、输入固定（Input Stationary，IS）数据流。</p>
<ul>
<li>输出固定数据流
![屏幕截图 2024-03-21 130800](C:\Users\sirius\Desktop\notebook\img\屏幕截图 2024-03-21 130800.png)
其特点是：权重数据被广播到所有PE，输入特征数据再PE间流动，最终从PE 内读取结果。
问题是：需要多次将数据搬运至片上缓存或外存</li>
</ul>
<p>可重构架构（reconfigurable architecture）</p>


<h3 class="relative group">PE与PE阵列 
    <div id="pe%E4%B8%8Epe%E9%98%B5%E5%88%97" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#pe%E4%B8%8Epe%E9%98%B5%E5%88%97" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<hr>
<blockquote>
<p>TY  - CONF
AU  - Hongli Pan
AU  - Mingjiang Wang
AU  - Jingqun Li
PY  - 2018/05
DA  - 2018/05
TI  - Design of the key Structure of Convolutional Neural Network Reconfigurable Accelerator Based on ASIC
BT  - Proceedings of the 2018 International Conference on Network, Communication, Computer Engineering (NCCE 2018)
PB  - Atlantis Press
SP  - 301
EP  - 304
SN  - 1951-6851
UR  - <a href="https://doi.org/10.2991/ncce-18.2018.47"   target="_blank">
    https://doi.org/10.2991/ncce-18.2018.47</a>
DO  - 10.2991/ncce-18.2018.47
ID  - Pan2018/05
ER  -</p>
</blockquote>
<p>单个多模PE结构框图</p>
<center>
<img src="./img/屏幕截图 2024-03-20 151947.png" width="1500"/>
</center>
<center>
<font size=2 >
Figure 1. Crystal orientations in a hexagonal SiC polytype.(Reference:Synopsys.TCAD Sentaurus™ Tutorial.Sentaurus Device)
</font>
</center>
<ul>
<li>36 (4 x 9) Booth coding units.</li>
<li>16 Wallace tree_XXs units.</li>
<li>4 Wallace trees_0_X units</li>
<li>2 Wallace tree_1_X units</li>
<li>1 Wallace tree_2</li>
</ul>
<center>
<img src="./img/屏幕截图 2024-03-21 130800.png" width="500"/>
</center>
<center>
<font size=2 >
Figure 1. Crystal orientations in a hexagonal SiC polytype.(Reference:Synopsys.TCAD Sentaurus™ Tutorial.Sentaurus Device)
</font>
</center>


<h2 class="relative group">Systolic Array 脉动阵列 
    <div id="systolic-array-%E8%84%89%E5%8A%A8%E9%98%B5%E5%88%97" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#systolic-array-%E8%84%89%E5%8A%A8%E9%98%B5%E5%88%97" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>一般的脉动阵列结构适用于二维矩阵乘，<font color="red">但是怎么用来计算二维卷积？？？</font></p>
<blockquote>
<p>[1] &quot; An in-depth look at Google’s firstTensor Processing Unit (TPU) &quot;</p>
<p><a href="https://cloud.google.com/blog/big-data/2017/05/an-in-depth-look-at-googles-first-tensor-processing-unit-tpu"   target="_blank">
    https://cloud.google.com/blog/big-data/2017/05/an-in-depth-look-at-googles-first-tensor-processing-unit-tpu</a></p>
<p>[2] &ldquo;脉动阵列 - 因Google TPU获得新生&rdquo; <a href="https://zhuanlan.zhihu.com/p/26522315"   target="_blank">
    https://zhuanlan.zhihu.com/p/26522315</a></p>
<p>[3] &quot; Should We All Embrace SystolicArrays?&quot;</p>
<p><a href="https://www.linkedin.com/pulse/should-we-all-embrace-systolic-arrays-chien-ping-lu"   target="_blank">
    https://www.linkedin.com/pulse/should-we-all-embrace-systolic-arrays-chien-ping-lu</a></p>
<p>[4] Norman P. Jouppi, etal.&ldquo;In-Datacenter Performance Analysis of a Tensor Processing Unit&rdquo;，accepted byISCA 2017</p>
<p>[5] Wei, Xuechao, et al. &ldquo;AutomatedSystolic Array Architecture Synthesis for High Throughput CNN Inference onFPGAs.&rdquo; Proceedings of the 54th Annual Design Automation Conference 2017.ACM, 2017.</p>
<p>[6] <a href="https://blog.csdn.net/wordwarwordwar/article/details/103537996?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_utm_term~default-0-103537996-blog-124088326.235%5ev43%5epc_blog_bottom_relevance_base1&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=3"   target="_blank">
    https://blog.csdn.net/wordwarwordwar/article/details/103537996?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_utm_term~default-0-103537996-blog-124088326.235^v43^pc_blog_bottom_relevance_base1&spm=1001.2101.3001.4242.1&utm_relevant_index=3</a></p>
<p>[7].https://blog.csdn.net/qq_34037046/article/details/89640853</p>
<p>[8].https://blog.csdn.net/m0_50735735/article/details/124088326?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171064726416800211534373%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=171064726416800211534373&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-124088326-null-null.142^v99^control&amp;utm_term=%E5%8D%B7%E7%A7%AF%E8%AE%A1%E7%AE%97%E7%9A%84%E8%84%89%E5%8A%A8%E9%98%B5%E5%88%97%E7%BB%93%E6%9E%84&amp;spm=1018.2226.3001.4187</p>
<p>[9].https://blog.csdn.net/m0_57102661/article/details/135005378?spm=1001.2101.3001.6650.4&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-4-135005378-blog-123842414.235%5Ev43%5Epc_blog_bottom_relevance_base1&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-4-135005378-blog-123842414.235%5Ev43%5Epc_blog_bottom_relevance_base1&amp;utm_relevant_index=9]</p>
</blockquote>
<ul>
<li>将卷积计算转化成二维矩阵乘法。</li>
</ul>
<p>一般来说，神经网络处理器分别将activation inputs和weight inputs放到矩阵的行和列中。activation和weight在脉动阵列中右传、下传，直到到达指定的cell中的指定寄存器。一旦input放好了，通过控制信号，处理器就开始用存在cell中的inputs计算得到output。处理器在把activation矩阵送进systolic array之前会先把矩阵“压扁”。如下图，矩阵在深度上有三个通道602, 604, 606。不同通道上的二维矩阵式送到脉动阵列中的不同行。在那张脉动阵列的图中，可以看到，第一行的输入是左边矩阵602这一层，第二行的输入是右边矩阵604这一层。weight那边，也有好多kernel，比方说下面这个例子中有Kernel A-D，不同kernel送到不同列。当把一个矩阵数据送到一个阵列中，矩阵的第一个元素在一个clock cycle中被送到cell中，在下一个的clock cycle，下一个元素被送到cell中，第一个元素被传递到相邻的cell中。（？？？？）</p>
<center>
<img src="./img/屏幕截图 2024-04-01 081026.png" width="500"/>
</center>
<center>
<font size=2 >
Figure 
</font>
</center>
<center>
<img src="./img/屏幕截图 2024-04-01 081135.png" width="500"/>
</center>
<center>
<font size=2 >
Figure 
</font>
</center>
<p>TPU中，如果采用rotatingdata的话，就会需要额外的资源完成这项任务，具体这个的代价在论文和专利中都没有细说。</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">加法器设计-Adders 
    <div id="%E5%8A%A0%E6%B3%95%E5%99%A8%E8%AE%BE%E8%AE%A1-adders" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%8A%A0%E6%B3%95%E5%99%A8%E8%AE%BE%E8%AE%A1-adders" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>通常认为加法器耗费的主要时间是进位传播时间。如何从时间、效率、相对成本进行优化？</p>


<h3 class="relative group">CPA - carry propagate adder 
    <div id="cpa---carry-propagate-adder" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cpa---carry-propagate-adder" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<blockquote>
<p><a href="https://www.vdfalliance.org/news/open-vdf-carry-propagate-adders"   target="_blank">
    https://www.vdfalliance.org/news/open-vdf-carry-propagate-adders</a></p>
</blockquote>
<p>CPA(Carry Propagate Adder)是一种常用的加法器电路,它按位进行两个二进制数的加法运算。</p>
<p>CPA的基本原理是:</p>
<ol>
<li>将两个二进制数对应位相加,得到一个总和位sum和一个进位carry。</li>
<li>将前一位的进位carry与当前位相加。</li>
<li>依次类推,对每一位执行上述操作,直至最高位。</li>
</ol>
<p>CPA由多个全加器(Full Adder)级联而成。每个全加器接收3个输入bit(被加数的一位、加数的一位和前一位的进位carry),根据加法真值表计算出一个总和sum和一个新的进位cout。</p>
<p>CPA的优点是结构简单、原理容易理解。但随着加法位数的增加,CPA中进位的传播链路会越来越长,从低位到高位需要多个时钟周期,从而降低了运算速度。</p>
<p>为了提高大位数加法的运算速度,现代处理器通常采用更先进的加法器如先行进位加法器(Carry Look-ahead Adder)、条件总和加法器(Conditional Sum Adder)等,它们预先计算并传递进位,缩短了进位传播的路径和时间。</p>
<p>总的来说,CPA是一种传统加法器,它的工作原理简单直观,适合位数不太高的加法操作,但处理大位数时会存在速度瓶颈。</p>
<p>实现代码：</p>
<blockquote>
<p><a href="https://github.com/supranational/hardware/"   target="_blank">
    https://github.com/supranational/hardware/</a>,其中包含CPA**(carry propagate adder)<strong>，CSA</strong>(carry save adder)**</p>
</blockquote>
<div style="page-break-after:always"></div>


<h2 class="relative group">乘法器设计-Multiplier Design 
    <div id="%E4%B9%98%E6%B3%95%E5%99%A8%E8%AE%BE%E8%AE%A1-multiplier-design" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%B9%98%E6%B3%95%E5%99%A8%E8%AE%BE%E8%AE%A1-multiplier-design" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<blockquote>
<p>F. U. D. Farrukh et al., &ldquo;Power Efficient Tiny Yolo CNN Using Reduced Hardware Resources Based on Booth Multiplier and WALLACE Tree Adders,&rdquo; in IEEE Open Journal of Circuits and Systems, vol. 1, pp. 76-87, 2020, doi: 10.1109/OJCAS.2020.3007334.
keywords: {Field programmable gate arrays;Convolution;Hardware;Adders;System-on-chip;Kernel;Task analysis;Convolutional neural network;booth encoding multiplier;WALLACE tree adders;FPGA;adder tree;object detection},</p>
</blockquote>


<h3 class="relative group">parallel multipliers 
    <div id="parallel-multipliers" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#parallel-multipliers" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>并行乘法器包含3种操作：部分积生成、部分积压缩、使用进位传播加法器(Carry Propagate Adder,CPA)相加。</p>
<ul>
<li>部分积生成</li>
</ul>
<p>1、使用ANDing operation</p>
<p>部分积$PP_L$由乘数的每一位$b_L$与被乘数的所有位相乘。可以参考下图。</p>
<center>
<img src="./img/屏幕截图 2024-03-28 195846.png" width="800"/>
</center>
<center>
<font size=2 >
Fig.Generation of partial products using ANDing operation.
</font>
</center>
<p>2、使用 modified Booth encoding algorithm</p>
<p>产生部分积后需要有效的对$PP_s$压缩。具体来说,它指出在使用部分乘积方法进行乘法运算时,生成所有部分乘积后,需要对这些部分乘积进行适当的简化和压缩,以降低计算复杂度和加法步骤。</p>
<p>简化部分乘积的方法有:</p>
<p>垂直对齐部分乘积,方便进位相加。
压缩可并入同一位的部分乘积,如23x14中的230可与92并入得322。
舍去多余的前导0,减少不必要的位数。
利用乘法分配率等代数性质,合并部分乘积项。
通过以上措施减少部分乘积的数量和位数,可以有效降低后续加法运算的复杂度,从而提高乘法计算的效率。因此,在生成所有部分乘积后,对它们进行整理简化是很有必要的。</p>
<p>WALLACE reduction是最常用的方案。</p>


<h3 class="relative group">WALLACE TREE MULTIPLIER 
    <div id="wallace-tree-multiplier" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#wallace-tree-multiplier" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<center>
<img src="./img/屏幕截图 2024-03-28 221636.png" width="800"/>
</center>
<center>
<font size=2 >
Fig.WALLACE tree multiplier (WM) for CNN accelerator.
</font>
</center>
<p>在这个设计中输入特侦图和内核权重作为乘法器的输入，产生PPs（Partial Products），其中的AND op如前免得图像所描述。产生部分积后通过华莱士树Reduction产生部分和。为了进一步简化设计，使用了组合逻辑电路来实现全加器（FA）和半加器（HA），based on the CSA technique.</p>
<p>16-bit 乘法器将会产生16位的部分积，在路径上有6个FA的延迟。减少PPs的位数是另一种优化技术。</p>
<p>MBE乘法器设计可以进一步减少PPs的位数，消耗更少的硬件资源（与WALLACE tree multiplier相比）。</p>
<p>因此可以用MBE来替代WALLACE tree multiplier</p>


<h3 class="relative group">MODIFIED BOOTH ENCODING MULTIPLIER (RADIX-4) 
    <div id="modified-booth-encoding-multiplier-radix-4" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#modified-booth-encoding-multiplier-radix-4" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Booth编码算法是一种用于执行有符号二进制数乘法的有效算法。它通过重新编码乘数位来减少部分乘积的数量,从而加速乘法运算。</p>
<p>Booth算法的基本思路如下:</p>
<ol>
<li>从乘数的最低有效位(LSB)开始,将乘数按位对扫描,每次使用当前遇到的两位。</li>
<li>如果遇到两位模式为&quot;01&quot;,则与上一个操作相反,执行1次A(加上A或减去A，A是被乘数)。</li>
<li>如果遇到&quot;00&quot;或&quot;11&quot;,则不执行任何操作。</li>
<li>如果遇到&quot;10&quot;,则与上一个操作相同,执行1次A。</li>
<li>乘数位移一位,返回第2步,直到最高有效位(MSB)被遍历。</li>
</ol>
<p>Booth算法的优势在于它可以通过编码将连续的1视为一个数值,从而大大减少了乘法中需要执行的部分乘积次数。这种方法比经典的乘法加/移位算法更高效。</p>
<p>Booth算法广泛应用于数字信号处理器(DSP)和现代CPU中,可以显著提高乘法运算的性能。</p>
<p>假设A和B分别是k-bit和l-bit 的整数二进制补码。其中A是被乘数（multiplicand），B是multiplier（乘数）。
$$
A=-a_{k-1} \cdot 2^{k-1} + \sum_{i=0}^{k-2} a_i \cdot 2^i
$$</p>
<p>$$
B=-b_{l-1} \cdot 2^{l-1} + \sum_{j=0}^{l-2} b_j \cdot 2^j
$$
Booth encoding algorithm可以在二进制补码乘法或无符号乘法中。</p>
<blockquote>
<p>O. L. Macsorley, &ldquo;High-Speed Arithmetic in Binary Computers,&rdquo; in Proceedings of the IRE, vol. 49, no. 1, pp. 67-91, Jan. 1961, doi: 10.1109/JRPROC.1961.287779.
keywords: {Digital arithmetic;Adders;Registers;Costs;Senior members;Concurrent computing;Application software;Logic circuits;Data systems},</p>
<p>这篇文章讨论了加快基本运算速度的一些方法，可以从运算效率和硬件成本两方面来比较。文章从加法、乘法、除法三个部分进行了详细介绍。</p>
</blockquote>
<p>二进制补码乘法：</p>
<ul>
<li>在B的最右侧追加一个“0”。</li>
<li>l应该是偶数，如果现在l成了奇数，那应该对B进行符号拓展。</li>
</ul>
<p>无符号乘法：</p>
<ul>
<li>l是奇数，则进行0拓展。</li>
<li>l是偶数，则在最高位补两个0。</li>
</ul>
<p><font color="red">为什么要使l是偶数？</font>因为乘法器通常是为偶数位宽而设计的。通过扩展B的位宽并在最右边添加0,可以确保乘法运算的结果不会溢出或丢失数据。</p>
<p>B按组进行编码：对于$j \in { 0,2,3,4&hellip;,l-2 }$，$b_{j+1},b_j,b_{j-1}$编码形成$b^{&rsquo;}<em>{\alpha}$，是一个有符号数，$\alpha = j/2$,且$b^{&rsquo;}</em>{ \alpha }= -2b_{j+1}+b_j+b_{j-1}$。每个部分积PP或者说$P_{\alpha}$由A与$b^{&rsquo;}_{\alpha}$相乘产生。</p>
<p>最终的乘积P的计算方法如下所示：
$$
P=\sum^{l/2-1}<em>{\alpha=0}P</em>{\alpha} \cdot 2^{2\alpha}=\sum^{l/2-1}<em>{\alpha=0}A\cdot b</em>{\alpha}^{&rsquo;} \cdot 2^{2\alpha}
$$</p>
<center>
<img src="./img/屏幕截图 2024-04-01 160410.png" width="400"/>
</center>
<center>
<font size=2 >
Table.Radix-4 modified booth encoding and partial-product selection.
</font>
</center>
<div style="page-break-after:always"></div>


<h2 class="relative group">CNN硬件IP 
    <div id="cnn%E7%A1%AC%E4%BB%B6ip" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cnn%E7%A1%AC%E4%BB%B6ip" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>卷积神经网络的硬件IP主要包含：卷积计算模块、池化模块、上采样模块、输入输出模块。其中输入输出模块通过AXI高速总线接口与片外DDR存储进行数据交互。在一次网络推理过程中，先从DDR中读取数据到片上进行缓存，等输入特征图和权重同步后送入卷积模块中进行卷积运算操作，完成运算后进行池化等其他模块计算完成后送到输出模块输出并存储<sup>[2]</sup>。</p>


<h3 class="relative group">V1 
    <div id="v1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#v1" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<blockquote>
<p>赵玉琳,王东辉,王雷欧.卷积神经网络卷积层的FPGA实现[J].网络新媒体技术,2021,10(01):47-50.</p>
</blockquote>
<center>
<img src="./img/屏幕截图 2024-03-30 215457.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.卷积层设计结构图.
</font>
</center>
<p>卷积层和池化层实行流水线式的结构设计，卷积核大小选取为3×3，输入特征图大小为224×224。池化窗口为2×2，池化步长为2。每个时钟周期输出1个像素<font color="red">（这里一个像素具体多少bits呢，经过量化的应该是8bits吧，本文的像素采用16位定点精度）</font>。输入特征图像素首先从外部输入到缓冲Buffer模块进行缓冲，相邻的卷积运算中，输入特征图的像素存在着重叠和重用，因此必须对输入特征图的像素进行缓冲设计，从而提高数据重用性，减少对数据输入带宽的要求。Buffer模块是由寄存器组设计的FIFO(First in First Out)，宽度为4个像素，深度为112+2，共4×(112+2)=456个像素。</p>
<blockquote>
<p>112+2中的“+2”的原因可能是在卷积运算的过程中，需要在输入特征图进行边界填充(padding)，填充0值 .</p>
<p>224×224=112×112×4，进行padding需要往外边扩2行。padding之后的大小是228*228=51984.注意51984/456=114.</p>
</blockquote>
<center>
<img src="./img/微信图片_20240331111057.jpg" width="500"/>
</center>
<center>
<font size=2 >
Fig.padding.
</font>
</center>
<p>缓冲过程如下图所示（${\color{red} ？}$）：</p>
<blockquote>
<p>下面这个图表示的是padding之后的输入图像。即、其大小是228×228。而图中的一行（两行方块）所占据的像素有2×228=456。456正好是FIFO所能容纳的大小。</p>
</blockquote>
<center>
<img src="./img/屏幕截图 2024-03-31 090632.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.像素输入顺序图.
</font>
</center>
<p>(a).每个时钟周期向Buffer模块输入4个像素，待buffer模块填满，填充阶段结束，开始给卷积模块送数据计算。</p>
<p>(b).每个时钟周期向buffer模块输入4个像素，同时移出最早的4个像素，将最早输入的8个像素和最近输入的8个像素组成4×4像素组，送给Conv模块进行卷积。</p>
<p>(c).在图c这个状态时显然不需要进行卷积计算。</p>
<blockquote>
<p><font color="red">既然卷积核的大小是3×3，那为什么要组成4×4的像素组，而不用3×3的像素组？</font></p>
<p>往下看</p>
</blockquote>
<p>池化窗口为2×2，池化层需要每个时钟周期并行输入4个像素。那么就要求卷积层每个时钟周期能够产生4个输出特征图像像素。所以需要4×4的像素组输入，正好可以产生2×2的输出。此时Conv模块内需要4×3×3个乘法器，4×8个加法器。</p>
<p>卷积计算后会经过激活函数处理。</p>


<h3 class="relative group">FIFO 
    <div id="fifo" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#fifo" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>first in first out，存储器结构，由存储单元队列或阵列构成。</p>
<p>为什么需要FIFO？</p>
<ul>
<li>当输入数据速率和输出数据速率不匹配时，用FIFO做为临时单元。</li>
<li>用于不同时钟域之间的同步。用FIFO起到数据同步作用。</li>
<li>输入数据路径和输出数据路径之间数据宽度不匹配时，用于数据宽度调整电路。</li>
</ul>
<p><font color="red"><strong>如何确定FIFO所需要的深度？</strong></font></p>
<p>​	当一定数量的数据必须从一个模块传输到另一个模块以避免数据丢失时，我们需要在不同时钟域工作的两个模块之间采用异步FIFO。FIFO是必需的，只有当你读得慢，写得快，以缓冲不被较慢的模块读取的数据。FIFO的深度(大小)应该以这样的方式，FIFO可以存储所有不被较慢的模块读取的数据。FIFO只在数据突发时才会起作用;你不能有连续的数据输入和输出。如果有连续的数据流，那么FIFO所需的大小应该是无限的。你需要知道突发速率，突发大小，频率等，以确定适当的FIFO大小。</p>
<p>​	固定fifo大小的逻辑是找到在一次突发中，写入过程完成的一段时间内还没有读取的数据大小。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="c1">//同步fifo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">module</span> <span class="n">fifo</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span> 	
</span></span><span class="line"><span class="cl">    <span class="k">input</span>  <span class="n">clk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">input</span>  <span class="n">rst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">input</span>  <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">din0</span><span class="p">,</span><span class="n">din1</span><span class="p">,</span><span class="n">din2</span><span class="p">,</span><span class="n">din3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">input</span>  <span class="n">wr_en</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">input</span>  <span class="n">rd_en</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">input</span>  <span class="n">rd_rst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">output</span> <span class="n">empty</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">output</span> <span class="n">full</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dout0</span><span class="p">,</span><span class="n">dout1</span><span class="p">,</span><span class="n">dout2</span><span class="p">,</span><span class="n">dout3</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">rd_ptr</span><span class="p">,</span> <span class="n">wr_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">reg</span> <span class="p">[</span><span class="mh">4</span><span class="o">*</span><span class="mh">8</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mem</span> <span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">113</span><span class="p">];</span><span class="c1">// 深度为 114
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dout_r0</span><span class="p">,</span><span class="n">dout_r1</span><span class="p">,</span><span class="n">dout_r2</span><span class="p">,</span><span class="n">dout_r3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">assign</span> <span class="n">empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">wr_ptr</span> <span class="o">==</span> <span class="n">rd_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">assign</span> <span class="n">full</span>  <span class="o">=</span> <span class="p">((</span><span class="n">wr_ptr</span> <span class="o">-</span> <span class="n">rd_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="mh">8</span><span class="mi">&#39;d114</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 延迟一拍
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">reg</span> <span class="n">wr_en_delay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span><span class="k">begin</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">wr_en_delay</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">wr_en_delay</span> <span class="o">&lt;=</span> <span class="n">wr_en</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="c1">//在该FIFO模块中，`wr_en_delay` 是一个寄存器延迟变量，其目的是为了确保在上升沿时 `wr_en_delay` 的值是在时钟上升沿之前的状态。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//在 Verilog 中，一个寄存器或变量的值在时钟信号的上升沿发生变化，而在该上升沿之后，才能在下一个时钟周期中读取到新的值。如果您直
</span></span></span><span class="line"><span class="cl"><span class="c1">//接使用 `wr_en` 信号进行写操作，那么在时钟上升沿时，`wr_en` 的值可能已经发生了变化，但您在同一个时钟周期中写入的是上一个时钟
</span></span></span><span class="line"><span class="cl"><span class="c1">//周期的值，而不是当前时钟周期的值。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//因此，为了确保在写操作中使用的是当前时钟周期的值，需要将 `wr_en` 信号延迟一个时钟周期，使其在下一个时钟周期中生效。这就是使用
</span></span></span><span class="line"><span class="cl"><span class="c1">// `wr_en_delay` 变量的原因，它在时钟上升沿之前记录了上一个时钟周期中的 `wr_en` 信号的值，并在下一个时钟周期中使用。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 读操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst</span><span class="p">)</span><span class="k">begin</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span><span class="k">begin</span>
</span></span><span class="line"><span class="cl">            <span class="n">dout_r0</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r1</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r2</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r3</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rd_en</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">empty</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r0</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">rd_ptr</span><span class="p">][</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r1</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">rd_ptr</span><span class="p">][</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r2</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">rd_ptr</span><span class="p">][</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">dout_r3</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">rd_ptr</span><span class="p">][</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">	<span class="k">end</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 写操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="k">begin</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">rst</span> <span class="o">&amp;&amp;</span> <span class="n">wr_en_delay</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">full</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">mem</span><span class="p">[</span><span class="n">wr_ptr</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="n">din3</span><span class="p">,</span><span class="n">din2</span><span class="p">,</span><span class="n">din1</span><span class="p">,</span><span class="n">din0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">end</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 写指针递增	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="k">begin</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">			<span class="n">wr_ptr</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">full</span> <span class="o">&amp;&amp;</span> <span class="n">wr_en_delay</span><span class="p">)</span><span class="c1">// 非满且写使能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">wr_ptr</span> <span class="o">&lt;=</span> <span class="n">wr_ptr</span> <span class="o">+</span> <span class="mh">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">end</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 读指针递增
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="k">begin</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">rd_ptr</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">rd_rst</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">				<span class="n">rd_ptr</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">empty</span> <span class="o">&amp;&amp;</span> <span class="n">rd_en</span><span class="p">)</span><span class="c1">// 非空且读使能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">rd_ptr</span> <span class="o">&lt;=</span> <span class="n">rd_ptr</span> <span class="o">+</span> <span class="mh">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">end</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">assign</span> <span class="n">dout0</span> <span class="o">=</span> <span class="n">dout_r0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assign</span> <span class="n">dout1</span> <span class="o">=</span> <span class="n">dout_r1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">assign</span> <span class="n">dout2</span> <span class="o">=</span> <span class="n">dout_r2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">assign</span> <span class="n">dout3</span> <span class="o">=</span> <span class="n">dout_r3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span> 
</span></span></code></pre></div><hr>


<h4 class="relative group">FIFO验证代码 
    <div id="fifo%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#fifo%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="no">`timescale</span> <span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="n">tb_fifo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="n">clock</span><span class="p">,</span><span class="n">reset</span><span class="p">,</span><span class="n">wr_en</span><span class="p">,</span><span class="n">rd_en</span><span class="p">,</span><span class="n">rd_rst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">din0</span><span class="p">,</span><span class="n">din1</span><span class="p">,</span><span class="n">din2</span><span class="p">,</span><span class="n">din3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="n">empty</span><span class="p">,</span><span class="n">full</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dout0</span><span class="p">,</span><span class="n">dout1</span><span class="p">,</span><span class="n">dout2</span><span class="p">,</span><span class="n">dout3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fifo</span> <span class="n">U1</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">clk</span>    <span class="p">(</span><span class="n">clock</span><span class="p">)</span>       <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">rst</span>      <span class="p">(</span><span class="n">reset</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">wr_en</span>   <span class="p">(</span><span class="n">wr_en</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">rd_rst</span> <span class="p">(</span><span class="n">rd_rst</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">rd_en</span> <span class="p">(</span><span class="n">rd_en</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">din0</span>  <span class="p">(</span><span class="n">din0</span><span class="p">)</span>  <span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">din1</span>  <span class="p">(</span><span class="n">din1</span><span class="p">)</span>  <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">din2</span>  <span class="p">(</span><span class="n">din2</span><span class="p">)</span>        <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">din3</span>  <span class="p">(</span><span class="n">din3</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">empty</span>  <span class="p">(</span><span class="n">empty</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">full</span>  <span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dout0</span>  <span class="p">(</span><span class="n">dout0</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dout1</span>  <span class="p">(</span><span class="n">dout1</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dout2</span>  <span class="p">(</span><span class="n">dout2</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dout3</span>  <span class="p">(</span><span class="n">dout3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">clock</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span> <span class="c1">// 初始时钟信号为低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">forever</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">5</span> <span class="n">clock</span> <span class="o">=</span> <span class="o">~</span><span class="n">clock</span><span class="p">;</span> <span class="c1">// 产生 100MHz 的时钟信号，周期 10ns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">din0</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din1</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din2</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din3</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">wr_en</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rd_en</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rd_rst</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>  <span class="c1">//10ns时reset有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span> 
</span></span><span class="line"><span class="cl">        <span class="n">rd_rst</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">wr_en</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rd_en</span> <span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">20</span>
</span></span><span class="line"><span class="cl">        <span class="n">din0</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din1</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din2</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din3</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">rd_en</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">din0</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din1</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din2</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din3</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">din0</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din1</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din2</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">din3</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">wr_en</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rd_en</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">仿真波形结果 
    <div id="%E4%BB%BF%E7%9C%9F%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%BB%BF%E7%9C%9F%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/屏幕截图 2024-04-07 101638.png" width="1000"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>


<h3 class="relative group">Conv 设计思路以及RTL代码 
    <div id="conv-%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E4%BB%A5%E5%8F%8Artl%E4%BB%A3%E7%A0%81" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conv-%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E4%BB%A5%E5%8F%8Artl%E4%BB%A3%E7%A0%81" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>1×1大小的卷积核转化为3×3的卷积核。</p>
<p>方法：将1×1的卷积核放在中心位置，然后在其外围的位置进行补0操作，即可将1×1大小的卷积核转化
成3×3的，以统一卷积核的尺寸。</p>
<p>为了保证卷积前后的特征图尺寸不发生变化，需要进行padding。padding操作应该放在FIFO缓存前进行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="c1">//只考虑简单的二维卷积情况,数据是8bits,每个时钟周期要能产生4个像素输出。这是否意味着每个时钟周期也要接受新的输入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">module</span> <span class="n">conv</span> <span class="p">#(</span>
</span></span><span class="line"><span class="cl">    <span class="k">parameter</span> <span class="n">input_width</span> <span class="o">=</span> <span class="mh">4</span><span class="p">,</span>   <span class="c1">//输入图像的宽
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">input_height</span> <span class="o">=</span> <span class="mh">4</span><span class="p">,</span>    <span class="c1">//输入图像的高
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">kernel_width</span> <span class="o">=</span> <span class="mh">3</span><span class="p">,</span>     <span class="c1">//卷积核的宽度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">kernel_height</span> <span class="o">=</span> <span class="mh">3</span><span class="p">,</span>    <span class="c1">//卷积核的高度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">output_width</span> <span class="o">=</span> <span class="mh">2</span><span class="p">,</span>     <span class="c1">//输出特征图的宽度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">output_height</span> <span class="o">=</span> <span class="mh">2</span><span class="p">,</span>    <span class="c1">//输出特征图的高度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">stride</span> <span class="o">=</span> <span class="mh">1</span><span class="p">,</span>          <span class="c1">//卷积核移动的步长
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">DATA_WIDTH</span> <span class="o">=</span> <span class="mh">8</span>       <span class="c1">//数据位宽（bits）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">rst</span><span class="p">,</span><span class="c1">//下降沿触发,在clk有效时，rst为0也会触发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//input initial_k, //初始化权值信号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">input</span> <span class="n">input_v</span><span class="p">,</span>    <span class="c1">//输入有效信号,要求像素和权值同时有效,高电平有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">input</span>  <span class="k">signed</span> <span class="p">[(</span><span class="n">input_width</span><span class="o">*</span><span class="n">input_height</span><span class="p">)</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">input_data</span><span class="p">,</span>  <span class="c1">//输入数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">input</span> <span class="k">signed</span> <span class="p">[(</span><span class="n">kernel_height</span><span class="o">*</span><span class="n">kernel_width</span><span class="p">)</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">weights</span><span class="p">,</span> <span class="c1">//卷积核权值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">output</span> <span class="n">dout_v</span><span class="p">,</span>   <span class="c1">//输出信号有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">output</span> <span class="p">[</span><span class="mh">2</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">+</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">aoutput_data</span><span class="p">,</span><span class="n">boutput_data</span><span class="p">,</span><span class="n">coutput_data</span><span class="p">,</span><span class="n">doutput_data</span> <span class="c1">//这里考虑乘法可能会造成位拓展
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">k00</span><span class="p">,</span><span class="n">k01</span><span class="p">,</span><span class="n">k02</span><span class="p">,</span><span class="n">k10</span><span class="p">,</span><span class="n">k11</span><span class="p">,</span><span class="n">k12</span><span class="p">,</span><span class="n">k20</span><span class="p">,</span><span class="n">k21</span><span class="p">,</span><span class="n">k22</span><span class="p">;</span><span class="c1">//卷积核权重寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">m00</span><span class="p">,</span><span class="n">m01</span><span class="p">,</span><span class="n">m02</span><span class="p">,</span><span class="n">m03</span><span class="p">,</span><span class="n">m10</span><span class="p">,</span><span class="n">m11</span><span class="p">,</span><span class="n">m12</span><span class="p">,</span><span class="n">m13</span><span class="p">,</span><span class="n">m20</span><span class="p">,</span><span class="n">m21</span><span class="p">,</span><span class="n">m22</span><span class="p">,</span><span class="n">m23</span><span class="p">,</span><span class="n">m30</span><span class="p">,</span><span class="n">m31</span><span class="p">,</span><span class="n">m32</span><span class="p">,</span><span class="n">m33</span><span class="p">;</span><span class="c1">//输入图像像素寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">2</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a00</span><span class="p">,</span><span class="n">a01</span><span class="p">,</span><span class="n">a02</span><span class="p">,</span><span class="n">a10</span><span class="p">,</span><span class="n">a11</span><span class="p">,</span><span class="n">a12</span><span class="p">,</span><span class="n">a20</span><span class="p">,</span><span class="n">a21</span><span class="p">,</span><span class="n">a22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">b00</span><span class="p">,</span><span class="n">b01</span><span class="p">,</span><span class="n">b02</span><span class="p">,</span><span class="n">b10</span><span class="p">,</span><span class="n">b11</span><span class="p">,</span><span class="n">b12</span><span class="p">,</span><span class="n">b20</span><span class="p">,</span><span class="n">b21</span><span class="p">,</span><span class="n">b22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">c00</span><span class="p">,</span><span class="n">c01</span><span class="p">,</span><span class="n">c02</span><span class="p">,</span><span class="n">c10</span><span class="p">,</span><span class="n">c11</span><span class="p">,</span><span class="n">c12</span><span class="p">,</span><span class="n">c20</span><span class="p">,</span><span class="n">c21</span><span class="p">,</span><span class="n">c22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">d00</span><span class="p">,</span><span class="n">d01</span><span class="p">,</span><span class="n">d02</span><span class="p">,</span><span class="n">d10</span><span class="p">,</span><span class="n">d11</span><span class="p">,</span><span class="n">d12</span><span class="p">,</span><span class="n">d20</span><span class="p">,</span><span class="n">d21</span><span class="p">,</span><span class="n">d22</span><span class="p">;</span><span class="c1">//卷积过程中的乘积
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">2</span><span class="o">*</span><span class="nl">DATA_WIDTH:</span><span class="mh">0</span><span class="p">]</span> <span class="n">asum0</span><span class="p">,</span><span class="n">asum1</span><span class="p">,</span><span class="n">asum2</span><span class="p">,</span><span class="n">asum3</span><span class="p">,</span><span class="n">asum4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">bsum0</span><span class="p">,</span><span class="n">bsum1</span><span class="p">,</span><span class="n">bsum2</span><span class="p">,</span><span class="n">bsum3</span><span class="p">,</span><span class="n">bsum4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">csum0</span><span class="p">,</span><span class="n">csum1</span><span class="p">,</span><span class="n">csum2</span><span class="p">,</span><span class="n">csum3</span><span class="p">,</span><span class="n">csum4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">dsum0</span><span class="p">,</span><span class="n">dsum1</span><span class="p">,</span><span class="n">dsum2</span><span class="p">,</span><span class="n">dsum3</span><span class="p">,</span><span class="n">dsum4</span><span class="p">;</span><span class="c1">//考虑加法可能上溢一位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">2</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">+</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a1sum0</span><span class="p">,</span><span class="n">a1sum1</span><span class="p">,</span><span class="n">a1sum2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">b1sum0</span><span class="p">,</span><span class="n">b1sum1</span><span class="p">,</span><span class="n">b1sum2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">c1sum0</span><span class="p">,</span><span class="n">c1sum1</span><span class="p">,</span><span class="n">c1sum2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">d1sum0</span><span class="p">,</span><span class="n">d1sum1</span><span class="p">,</span><span class="n">d1sum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">2</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">+</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a2sum0</span><span class="p">,</span><span class="n">a2sum1</span><span class="p">,</span><span class="n">b2sum0</span><span class="p">,</span><span class="n">b2sum1</span><span class="p">,</span><span class="n">c2sum0</span><span class="p">,</span><span class="n">c2sum1</span><span class="p">,</span><span class="n">d2sum0</span><span class="p">,</span><span class="n">d2sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">2</span><span class="o">*</span><span class="n">DATA_WIDTH</span><span class="o">+</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a3sum0</span><span class="p">,</span><span class="n">b3sum0</span><span class="p">,</span><span class="n">c3sum0</span><span class="p">,</span><span class="n">d3sum0</span><span class="p">;</span>                           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//reg out_v;
</span></span></span><span class="line"><span class="cl"><span class="c1">//同时初始化权重和像素矩阵，需要1个clk
</span></span></span><span class="line"><span class="cl"><span class="c1">//------------------------初始化卷积核(耗费1个clk)-------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rst</span> <span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">k00</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">k01</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">k02</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k10</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">k11</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">k12</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k20</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">k21</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">k22</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m00</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m01</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m02</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m03</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m10</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m11</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m12</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m13</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m20</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m21</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m22</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m23</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m30</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m31</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m32</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m33</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">end</span> 
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">begin</span> 
</span></span><span class="line"><span class="cl">        <span class="n">k00</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">k01</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">k02</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k10</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">k11</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">39</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">k12</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">40</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k20</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">55</span><span class="o">:</span><span class="mh">48</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">k21</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">56</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">k22</span> <span class="o">&lt;=</span> <span class="n">weights</span><span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m00</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m01</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m02</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m03</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m10</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">39</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m11</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">40</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m12</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">55</span><span class="o">:</span><span class="mh">48</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m13</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">56</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m20</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m21</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">79</span><span class="o">:</span><span class="mh">72</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m22</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">87</span><span class="o">:</span><span class="mh">80</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m23</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">95</span><span class="o">:</span><span class="mh">88</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="n">m30</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">103</span><span class="o">:</span><span class="mh">96</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m31</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">111</span><span class="o">:</span><span class="mh">104</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m32</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">119</span><span class="o">:</span><span class="mh">112</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">m33</span> <span class="o">&lt;=</span> <span class="n">input_data</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">120</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span> 
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//---------------------------计算乘法-----------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//------注意并行的4个卷积计算为了同时输出4个卷积结果--------流水线方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">a00</span><span class="o">&lt;=</span><span class="n">k00</span><span class="o">*</span><span class="n">m00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a01</span><span class="o">&lt;=</span><span class="n">k01</span><span class="o">*</span><span class="n">m01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a02</span><span class="o">&lt;=</span><span class="n">k02</span><span class="o">*</span><span class="n">m02</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a10</span><span class="o">&lt;=</span><span class="n">k10</span><span class="o">*</span><span class="n">m10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a11</span><span class="o">&lt;=</span><span class="n">k11</span><span class="o">*</span><span class="n">m11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a12</span><span class="o">&lt;=</span><span class="n">k12</span><span class="o">*</span><span class="n">m12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a20</span><span class="o">&lt;=</span><span class="n">k20</span><span class="o">*</span><span class="n">m20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a21</span><span class="o">&lt;=</span><span class="n">k21</span><span class="o">*</span><span class="n">m21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a22</span><span class="o">&lt;=</span><span class="n">k22</span><span class="o">*</span><span class="n">m22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">b00</span><span class="o">&lt;=</span><span class="n">k00</span><span class="o">*</span><span class="n">m01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b01</span><span class="o">&lt;=</span><span class="n">k01</span><span class="o">*</span><span class="n">m02</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b02</span><span class="o">&lt;=</span><span class="n">k02</span><span class="o">*</span><span class="n">m03</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b10</span><span class="o">&lt;=</span><span class="n">k10</span><span class="o">*</span><span class="n">m11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b11</span><span class="o">&lt;=</span><span class="n">k11</span><span class="o">*</span><span class="n">m12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b12</span><span class="o">&lt;=</span><span class="n">k12</span><span class="o">*</span><span class="n">m13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b20</span><span class="o">&lt;=</span><span class="n">k20</span><span class="o">*</span><span class="n">m21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b21</span><span class="o">&lt;=</span><span class="n">k21</span><span class="o">*</span><span class="n">m22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b22</span><span class="o">&lt;=</span><span class="n">k22</span><span class="o">*</span><span class="n">m23</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c00</span><span class="o">&lt;=</span><span class="n">k00</span><span class="o">*</span><span class="n">m10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c01</span><span class="o">&lt;=</span><span class="n">k01</span><span class="o">*</span><span class="n">m11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c02</span><span class="o">&lt;=</span><span class="n">k02</span><span class="o">*</span><span class="n">m12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c10</span><span class="o">&lt;=</span><span class="n">k10</span><span class="o">*</span><span class="n">m20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c11</span><span class="o">&lt;=</span><span class="n">k11</span><span class="o">*</span><span class="n">m21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c12</span><span class="o">&lt;=</span><span class="n">k12</span><span class="o">*</span><span class="n">m22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c20</span><span class="o">&lt;=</span><span class="n">k20</span><span class="o">*</span><span class="n">m30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c21</span><span class="o">&lt;=</span><span class="n">k21</span><span class="o">*</span><span class="n">m31</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c22</span><span class="o">&lt;=</span><span class="n">k22</span><span class="o">*</span><span class="n">m32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">d00</span><span class="o">&lt;=</span><span class="n">k00</span><span class="o">*</span><span class="n">m11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d01</span><span class="o">&lt;=</span><span class="n">k01</span><span class="o">*</span><span class="n">m12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d02</span><span class="o">&lt;=</span><span class="n">k02</span><span class="o">*</span><span class="n">m13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d10</span><span class="o">&lt;=</span><span class="n">k10</span><span class="o">*</span><span class="n">m21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d11</span><span class="o">&lt;=</span><span class="n">k11</span><span class="o">*</span><span class="n">m22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d12</span><span class="o">&lt;=</span><span class="n">k12</span><span class="o">*</span><span class="n">m23</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d20</span><span class="o">&lt;=</span><span class="n">k20</span><span class="o">*</span><span class="n">m31</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d21</span><span class="o">&lt;=</span><span class="n">k21</span><span class="o">*</span><span class="n">m32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d22</span><span class="o">&lt;=</span><span class="n">k22</span><span class="o">*</span><span class="n">m33</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//----------加法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">asum0</span><span class="o">&lt;=</span><span class="n">a00</span><span class="o">+</span><span class="n">a22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">asum1</span><span class="o">&lt;=</span><span class="n">a01</span><span class="o">+</span><span class="n">a21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">asum2</span><span class="o">&lt;=</span><span class="n">a02</span><span class="o">+</span><span class="n">a20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">asum3</span><span class="o">&lt;=</span><span class="n">a10</span><span class="o">+</span><span class="n">a12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">asum4</span><span class="o">&lt;=</span><span class="n">a11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bsum0</span><span class="o">&lt;=</span><span class="n">b00</span><span class="o">+</span><span class="n">b22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bsum1</span><span class="o">&lt;=</span><span class="n">b01</span><span class="o">+</span><span class="n">b21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bsum2</span><span class="o">&lt;=</span><span class="n">b02</span><span class="o">+</span><span class="n">b20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bsum3</span><span class="o">&lt;=</span><span class="n">b10</span><span class="o">+</span><span class="n">b12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bsum4</span><span class="o">&lt;=</span><span class="n">b11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">csum0</span><span class="o">&lt;=</span><span class="n">c00</span><span class="o">+</span><span class="n">c22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">csum1</span><span class="o">&lt;=</span><span class="n">c01</span><span class="o">+</span><span class="n">c21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">csum2</span><span class="o">&lt;=</span><span class="n">c02</span><span class="o">+</span><span class="n">c20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">csum3</span><span class="o">&lt;=</span><span class="n">c10</span><span class="o">+</span><span class="n">c12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">csum4</span><span class="o">&lt;=</span><span class="n">c11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dsum0</span><span class="o">&lt;=</span><span class="n">d00</span><span class="o">+</span><span class="n">d22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dsum1</span><span class="o">&lt;=</span><span class="n">d01</span><span class="o">+</span><span class="n">d21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dsum2</span><span class="o">&lt;=</span><span class="n">d02</span><span class="o">+</span><span class="n">d20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dsum3</span><span class="o">&lt;=</span><span class="n">d10</span><span class="o">+</span><span class="n">d12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dsum4</span><span class="o">&lt;=</span><span class="n">d11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">a1sum0</span><span class="o">&lt;=</span><span class="n">asum0</span><span class="o">+</span><span class="n">asum4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1sum1</span><span class="o">&lt;=</span><span class="n">asum1</span><span class="o">+</span><span class="n">asum3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1sum2</span><span class="o">&lt;=</span><span class="n">asum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">b1sum0</span><span class="o">&lt;=</span><span class="n">bsum0</span><span class="o">+</span><span class="n">bsum4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b1sum1</span><span class="o">&lt;=</span><span class="n">bsum1</span><span class="o">+</span><span class="n">bsum3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b1sum2</span><span class="o">&lt;=</span><span class="n">bsum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c1sum0</span><span class="o">&lt;=</span><span class="n">csum0</span><span class="o">+</span><span class="n">csum4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c1sum1</span><span class="o">&lt;=</span><span class="n">csum1</span><span class="o">+</span><span class="n">csum3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c1sum2</span><span class="o">&lt;=</span><span class="n">csum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">d1sum0</span><span class="o">&lt;=</span><span class="n">dsum0</span><span class="o">+</span><span class="n">dsum4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d1sum1</span><span class="o">&lt;=</span><span class="n">dsum1</span><span class="o">+</span><span class="n">dsum3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d1sum2</span><span class="o">&lt;=</span><span class="n">dsum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">a2sum0</span><span class="o">&lt;=</span><span class="n">a1sum0</span><span class="o">+</span><span class="n">a1sum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a2sum1</span><span class="o">&lt;=</span><span class="n">a1sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">b2sum0</span><span class="o">&lt;=</span><span class="n">b1sum0</span><span class="o">+</span><span class="n">b1sum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b2sum1</span><span class="o">&lt;=</span><span class="n">b1sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c2sum0</span><span class="o">&lt;=</span><span class="n">c1sum0</span><span class="o">+</span><span class="n">c1sum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c2sum1</span><span class="o">&lt;=</span><span class="n">c1sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">d2sum0</span><span class="o">&lt;=</span><span class="n">d1sum0</span><span class="o">+</span><span class="n">d1sum2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d2sum1</span><span class="o">&lt;=</span><span class="n">d1sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">a3sum0</span><span class="o">&lt;=</span><span class="n">a2sum0</span><span class="o">+</span><span class="n">a2sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b3sum0</span><span class="o">&lt;=</span><span class="n">b2sum0</span><span class="o">+</span><span class="n">b2sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c3sum0</span><span class="o">&lt;=</span><span class="n">c2sum0</span><span class="o">+</span><span class="n">c2sum1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d3sum0</span><span class="o">&lt;=</span><span class="n">d2sum0</span><span class="o">+</span><span class="n">d2sum1</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//用这种逻辑来判断有些复杂，不如直接把input_v延迟5个clk变成输出有效信号！！！！
</span></span></span><span class="line"><span class="cl"><span class="c1">// always@(posedge clk or negedge rst)
</span></span></span><span class="line"><span class="cl"><span class="c1">// begin
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if(!rst|| (input_v==1&#39;d0)&amp;&amp;(cont2==3&#39;d5)) begin
</span></span></span><span class="line"><span class="cl"><span class="c1">//         cont1&lt;=0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//     end else 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   
</span></span><span class="line"><span class="cl"><span class="c1">//         cont1&lt;=cont1+1&#39;d1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="c1">// end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// always@(posedge clk or negedge rst) 
</span></span></span><span class="line"><span class="cl"><span class="c1">// begin
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if(!rst || (input_v==1&#39;d1)&amp;&amp;(cont1==3&#39;d5) ) begin
</span></span></span><span class="line"><span class="cl"><span class="c1">//         cont2&lt;=0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//     end else
</span></span></span><span class="line"><span class="cl"><span class="c1">//         cont2&lt;=cont2+1&#39;d1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="c1">// end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// always@(posedge clk or negedge rst)
</span></span></span><span class="line"><span class="cl"><span class="c1">// begin
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if(!rst  || cont2==3&#39;d5) begin //cont2==3&#39;d5意味着距离最近的无效输入有5个clk，那这时输出应该无效
</span></span></span><span class="line"><span class="cl"><span class="c1">//         out_v&lt;=0;
</span></span></span><span class="line"><span class="cl"><span class="c1">//         cont1&lt;=0;
</span></span></span><span class="line"><span class="cl"><span class="c1">//     end else
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if(cont1 == 3&#39;d5) begin
</span></span></span><span class="line"><span class="cl"><span class="c1">//         out_v&lt;=1&#39;d1;
</span></span></span><span class="line"><span class="cl"><span class="c1">//         cont2&lt;=0;
</span></span></span><span class="line"><span class="cl"><span class="c1">//     end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl"><span class="c1">//end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">delay_reg</span><span class="p">;</span>  <span class="c1">// 5级寄存器延迟链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 时钟上升沿触发延迟寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay_reg</span> <span class="o">&lt;=</span> <span class="mh">5</span><span class="mb">&#39;b0</span><span class="p">;</span>  <span class="c1">// 复位时清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay_reg</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="n">delay_reg</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span> <span class="n">input_v</span><span class="p">};</span>  <span class="c1">// 输入信号移入延迟链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assign</span> <span class="n">aoutput_data</span> <span class="o">=</span> <span class="n">a3sum0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">assign</span> <span class="n">boutput_data</span> <span class="o">=</span> <span class="n">b3sum0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">assign</span> <span class="n">coutput_data</span> <span class="o">=</span> <span class="n">c3sum0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">assign</span> <span class="n">doutput_data</span> <span class="o">=</span> <span class="n">d3sum0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//assign dout_v=out_v;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">assign</span> <span class="n">dout_v</span><span class="o">=</span><span class="n">delay_reg</span><span class="p">[</span><span class="mh">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">仿真验证思路以及验证代码 
    <div id="%E4%BB%BF%E7%9C%9F%E9%AA%8C%E8%AF%81%E6%80%9D%E8%B7%AF%E4%BB%A5%E5%8F%8A%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%BB%BF%E7%9C%9F%E9%AA%8C%E8%AF%81%E6%80%9D%E8%B7%AF%E4%BB%A5%E5%8F%8A%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/屏幕截图 2024-04-06 113217.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="no">`timescale</span> <span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="n">tb_conv</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="n">clock</span><span class="p">,</span><span class="n">reset</span><span class="p">,</span><span class="n">input_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">input_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">weights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="n">dout_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">aoutput_data</span><span class="p">,</span><span class="n">boutput_data</span><span class="p">,</span><span class="n">coutput_data</span><span class="p">,</span><span class="n">doutput_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">conv</span> <span class="n">U1</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">clk</span>    <span class="p">(</span><span class="n">clock</span><span class="p">)</span>       <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">rst</span>      <span class="p">(</span><span class="n">reset</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">input_v</span>   <span class="p">(</span><span class="n">input_v</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">input_data</span> <span class="p">(</span><span class="n">input_data</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">weights</span> <span class="p">(</span><span class="n">weights</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dout_v</span>  <span class="p">(</span><span class="n">dout_v</span><span class="p">)</span>  <span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">aoutput_data</span>  <span class="p">(</span><span class="n">aoutput_data</span><span class="p">)</span>  <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">boutput_data</span>  <span class="p">(</span><span class="n">boutput_data</span><span class="p">)</span>        <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">coutput_data</span>  <span class="p">(</span><span class="n">coutput_data</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">doutput_data</span>  <span class="p">(</span><span class="n">doutput_data</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">clock</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span> <span class="c1">// 初始时钟信号为低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">forever</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">5</span> <span class="n">clock</span> <span class="o">=</span> <span class="o">~</span><span class="n">clock</span><span class="p">;</span> <span class="c1">// 产生 100MHz 的时钟信号，周期 10ns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_v</span><span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_data</span> <span class="o">=</span> <span class="mh">128</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">weights</span> <span class="o">=</span> <span class="mh">72</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>  <span class="c1">//10ns时reset有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_v</span><span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="mh">8</span><span class="mi">&#39;d15</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d14</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d13</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d12</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d11</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d10</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d9</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d7</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d4</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d3</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d2</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d7</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d4</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d3</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d2</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span> 
</span></span><span class="line"><span class="cl">        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="mh">8</span><span class="mi">&#39;d15</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d14</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d13</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d12</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d11</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d10</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d9</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d7</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d4</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d3</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d2</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span>   <span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="mh">8</span><span class="mi">&#39;d1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">20</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_v</span><span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">20</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_v</span><span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">80</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">modelsim仿真波形结果： 
    <div id="modelsim%E4%BB%BF%E7%9C%9F%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#modelsim%E4%BB%BF%E7%9C%9F%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/屏幕截图 2024-04-06 150836.png" width="1000"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>
<p>设计细节：</p>
<ul>
<li>
<p>rst和input_v同时为1，或者input_v先于rst为1，此时在rst跳变到1后5个clk之后，输出有效数据。</p>
</li>
<li>
<p>在上一种情况下，input_v并没有一直保持有效，而是中间过程出现了无效，出现这个状态后经过5个clk输出也要无效才行。</p>
</li>
</ul>
<p>方法：使用6级的寄存器延迟链直接将输入有效信号延迟输出。</p>


<h4 class="relative group">重点 
    <div id="%E9%87%8D%E7%82%B9" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%87%8D%E7%82%B9" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>实现卷积模块的两个重点：1、卷积运算的高效性。进行卷积运算时存在不同的模式，如果给不同的模式分配不同的模块会增加面积和功耗，可以通过配置寄存器的方式对同一模块多次复用，实现不同卷积运算的类型。2、片上数据缓存和数据复用</p>


<h4 class="relative group">卷积层并行加速的可行性分析 
    <div id="%E5%8D%B7%E7%A7%AF%E5%B1%82%E5%B9%B6%E8%A1%8C%E5%8A%A0%E9%80%9F%E7%9A%84%E5%8F%AF%E8%A1%8C%E6%80%A7%E5%88%86%E6%9E%90" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%8D%B7%E7%A7%AF%E5%B1%82%E5%B9%B6%E8%A1%8C%E5%8A%A0%E9%80%9F%E7%9A%84%E5%8F%AF%E8%A1%8C%E6%80%A7%E5%88%86%E6%9E%90" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/图片2.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.卷积窗口内并行
</font>
</center>
<center>
<img src="./img/图片3.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.卷积窗口并行
</font>
</center>
<center>
<img src="./img/图片4.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.输入通道并行
</font>
</center>


<h3 class="relative group">激活函数 
    <div id="%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>卷积神经网络中常用的激活函数有：Sigmoid、Tanh、Relu等。激活函数在硬件上实现的代价很大。主要的方法有：查找表法<sup>[3]</sup>、分段函数法<sup>[4]</sup>、泰勒级数展开法<sup>[5]</sup>与CORIDC算法<sup>[6]</sup>。对于类似Relu 这种分段函数一般采用分段函数法；对于Sigmoid 与Tanh 这类S 型曲线函数可以使用泰勒级数展开法与其它方法进行实现。</p>
<p>激活函数通常是非递减函数，因此池化层输出的最大值，在激活函数前也是最大值，因此可以将激活函数放到池化层之后，减少激活函数的计算次数。此处激活函数选取修正线性单元ReLU(Rectified Linear Unit)函数。</p>
<p>其形式化定义为：
$$
f(x)=max(0,x)
$$
在实现relu函数的过程中，有时可能会顺便带上量化，常见的是使用右移操作来进行定点数运算中的量化。量化的一种常见方式是通过移位操作来模拟乘除法。右移10位相当于除以2^10,即除以1024。这种做法通常是在对激活值进行量化时使用。为了量化到较低位宽的定点数表示,需要将输入值缩小到目标定点数的范围。通过右移10位,相当于将输入值除以1024,从而将较大的值映射到目标定点数表示范围内。这种移位运算量化的做法,可以大大节省资源,同时可控制精度损失,是定点数计算中的一种常用技术。</p>
<p>下面给出Relu函数的实现代码（没有进行量化）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="k">module</span> <span class="n">relu</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">rst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">valid_in</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data_in</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data_out</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">output</span> <span class="kt">reg</span> <span class="n">valid_out</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst</span> <span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_out</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">valid_out</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">valid_in</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">data_in</span><span class="p">[</span><span class="mh">7</span><span class="p">])</span> <span class="k">begin</span> <span class="c1">// 判断是否为负数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">data_out</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span> <span class="c1">// 负数输出为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">                    <span class="n">data_out</span> <span class="o">&lt;=</span> <span class="n">data_in</span><span class="p">;</span> <span class="c1">// 非负数直接输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">end</span>
</span></span><span class="line"><span class="cl">                <span class="n">valid_out</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">                <span class="n">valid_out</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">end</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">验证代码 
    <div id="%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="no">`timescale</span> <span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="n">tb_relu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="n">clock</span><span class="p">,</span><span class="n">reset</span><span class="p">,</span><span class="n">valid_in</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data_in</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="n">valid_out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data_out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">relu</span> <span class="n">U1</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">clk</span>    <span class="p">(</span><span class="n">clock</span><span class="p">)</span>       <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">rst</span>      <span class="p">(</span><span class="n">reset</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">valid_in</span>   <span class="p">(</span><span class="n">valid_in</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">data_in</span> <span class="p">(</span><span class="n">data_in</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">valid_out</span> <span class="p">(</span><span class="n">valid_out</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">data_out</span>  <span class="p">(</span><span class="n">data_out</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">clock</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span> <span class="c1">// 初始时钟信号为低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">forever</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">5</span> <span class="n">clock</span> <span class="o">=</span> <span class="o">~</span><span class="n">clock</span><span class="p">;</span> <span class="c1">// 产生 100MHz 的时钟信号，周期 10ns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">valid_in</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>  <span class="c1">//10ns时reset有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span> 
</span></span><span class="line"><span class="cl">        <span class="n">valid_in</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_in</span> <span class="o">=</span> <span class="o">-</span><span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">valid_in</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">波形结果 
    <div id="%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/屏幕截图 2024-04-07 105118.png" width="1000"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>


<h3 class="relative group">最大池化 
    <div id="%E6%9C%80%E5%A4%A7%E6%B1%A0%E5%8C%96" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%9C%80%E5%A4%A7%E6%B1%A0%E5%8C%96" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>池化窗口2×2，由3个比较器级联组成，最大值延迟两个时钟周期输出，采用流水线式的设计，可以保证每个时钟输出1 个像素值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="k">module</span> <span class="n">max_pooling_2_2</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">rst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">apixel_in</span><span class="p">,</span><span class="n">bpixel_in</span><span class="p">,</span><span class="n">cpixel_in</span><span class="p">,</span><span class="n">dpixel_in</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="n">pixel_in_valid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">output</span> <span class="n">pixel_out_valid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">pixel_out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">pixel_buffer</span> <span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">3</span><span class="p">];</span> <span class="c1">// 用于级联比较的像素缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">line_idx</span><span class="p">;</span> <span class="c1">// 行缓冲区索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">pixel_idx</span><span class="p">;</span> <span class="c1">// 像素缓冲区索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">output_idx</span><span class="p">;</span> <span class="c1">// 输出像素索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">max_pixel</span><span class="p">,</span><span class="n">max_pixel0</span><span class="p">,</span><span class="n">max_pixel1</span><span class="p">;</span> <span class="c1">// 最大像素值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">cont</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 第一级比较器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_pixel0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">1</span><span class="p">])</span> <span class="o">?</span> <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_pixel1</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">3</span><span class="p">])</span> <span class="o">?</span> <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span> <span class="o">:</span> <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">3</span><span class="p">];</span>    
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pixel0</span> <span class="o">&gt;</span> <span class="n">max_pixel1</span><span class="p">)</span> <span class="o">?</span> <span class="n">max_pixel0</span> <span class="o">:</span> <span class="n">max_pixel1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">delay_reg</span><span class="p">;</span>  <span class="c1">// 5级寄存器延迟链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 时钟上升沿触发延迟寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay_reg</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>  <span class="c1">// 复位时清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay_reg</span> <span class="o">&lt;=</span>  <span class="p">{</span><span class="n">delay_reg</span><span class="p">[</span><span class="mh">0</span><span class="p">],</span><span class="n">pixel_in_valid</span><span class="p">};</span>  <span class="c1">// 输入信号移入延迟链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">end</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pixel_in_valid</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 更新像素缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">apixel_in</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bpixel_in</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cpixel_in</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_buffer</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dpixel_in</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assign</span> <span class="n">pixel_out</span> <span class="o">=</span> <span class="n">max_pixel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">assign</span> <span class="n">pixel_out_valid</span> <span class="o">=</span> <span class="n">delay_reg</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">验证代码 
    <div id="%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81-1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81-1" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="no">`timescale</span> <span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="n">tb_max_pooling_2_2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="n">clock</span><span class="p">,</span><span class="n">reset</span><span class="p">,</span><span class="n">pixel_in_valid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">apixel_in</span><span class="p">,</span><span class="n">bpixel_in</span><span class="p">,</span><span class="n">cpixel_in</span><span class="p">,</span><span class="n">dpixel_in</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="n">pixel_out_valid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">wire</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">pixel_out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">max_pooling_2_2</span> <span class="n">U1</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">clk</span>    <span class="p">(</span><span class="n">clock</span><span class="p">)</span>       <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">rst</span>      <span class="p">(</span><span class="n">reset</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">pixel_in_valid</span>   <span class="p">(</span><span class="n">pixel_in_valid</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">apixel_in</span> <span class="p">(</span><span class="n">apixel_in</span><span class="p">)</span>    <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">bpixel_in</span> <span class="p">(</span><span class="n">bpixel_in</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">cpixel_in</span>  <span class="p">(</span><span class="n">cpixel_in</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dpixel_in</span>  <span class="p">(</span><span class="n">dpixel_in</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">pixel_out_valid</span>  <span class="p">(</span><span class="n">pixel_out_valid</span><span class="p">)</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">pixel_out</span>  <span class="p">(</span><span class="n">pixel_out</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="n">clock</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span> <span class="c1">// 初始时钟信号为低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">forever</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">5</span> <span class="n">clock</span> <span class="o">=</span> <span class="o">~</span><span class="n">clock</span><span class="p">;</span> <span class="c1">// 产生 100MHz 的时钟信号，周期 10ns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_in_valid</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">apixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d89</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d56</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>  <span class="c1">//10ns时reset有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span> <span class="o">=</span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_in_valid</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span> 
</span></span><span class="line"><span class="cl">        <span class="n">apixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d90</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">apixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d98</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">apixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d58</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d34</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d108</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">pixel_in_valid</span> <span class="o">=</span> <span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">apixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d89</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d98</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d27</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d116</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">#</span><span class="mh">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">apixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dpixel_in</span> <span class="o">=</span> <span class="mh">8</span><span class="mi">&#39;d88</span><span class="p">;</span>       
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h4 class="relative group">波形结果 
    <div id="%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C-1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%B3%A2%E5%BD%A2%E7%BB%93%E6%9E%9C-1" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/屏幕截图 2024-04-07 155806.png" width="1000"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>


<h3 class="relative group">全连接 
    <div id="%E5%85%A8%E8%BF%9E%E6%8E%A5" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%85%A8%E8%BF%9E%E6%8E%A5" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>全连接层(fully connected layers，FC)是<a href="https://so.csdn.net/so/search?q=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0&amp;spm=1001.2101.3001.7020"   target="_blank">
    深度学习</a>中常用的一种神经网络层，也称为密集连接层或多层感知机层。</p>
<p><a href="https://blog.csdn.net/qq_39522016/article/details/131949125"   target="_blank">
    https://blog.csdn.net/qq_39522016/article/details/131949125</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-verilog" data-lang="verilog"><span class="line"><span class="cl"><span class="k">module</span> <span class="n">FullyConnectedLayer_4096</span> <span class="p">#(</span>
</span></span><span class="line"><span class="cl">    <span class="k">parameter</span> <span class="n">INPUT_SIZE</span> <span class="o">=</span> <span class="mh">512</span><span class="p">,</span> <span class="c1">// 输入大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">parameter</span> <span class="n">OUTPUT_SIZE</span> <span class="o">=</span> <span class="mh">4096</span> <span class="c1">// 输出大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">    <span class="k">input</span> <span class="kt">wire</span> <span class="p">[</span><span class="n">INPUT_SIZE</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">input_data</span><span class="p">,</span> <span class="c1">// 输入数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">output</span> <span class="kt">wire</span> <span class="p">[</span><span class="n">OUTPUT_SIZE</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">output_data</span> <span class="c1">// 输出数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 定义权重和偏置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">reg</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">weights</span><span class="p">[</span><span class="n">OUTPUT_SIZE</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">reg</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">bias</span><span class="p">[</span><span class="n">OUTPUT_SIZE</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始化权重和偏置（这里简化为全为 0）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">initial</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OUTPUT_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 计算输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">temp_output</span><span class="p">[</span><span class="n">OUTPUT_SIZE</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">always</span> <span class="p">@</span><span class="o">*</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OUTPUT_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">INPUT_SIZE</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp_output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 输出数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">assign</span> <span class="n">output_data</span> <span class="o">=</span> <span class="n">temp_output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">endmodule</span>
</span></span></code></pre></div>

<h3 class="relative group">Top model 
    <div id="top-model" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#top-model" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<center>
<img src="./img/屏幕截图 2024-04-14 095939.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.CNN加速器内部架构示意图
</font>
</center>
<center>
<img src="./img/微信图片_20240414210922.jpg" width="500"/>
</center>
<center>
<font size=2 >
Fig.CNN加速器内部架构示意图
</font>
</center>
<div style="page-break-after:always"></div>


<h2 class="relative group">数据缓存 
    <div id="%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>因此利用硬件架构设计高吞吐量和优化的存储结构对于硬件平台实现卷积神经网络尤为重要，存储的执行效率影响着整个系统的加速性能。在FPGA上主要包含两种数据缓存方式<sup>[7]</sup>：乒乓缓存<sup>[8]</sup>、FIFO寄存器缓存<sup>[9]</sup>。</p>


<h3 class="relative group">乒乓缓存 
    <div id="%E4%B9%92%E4%B9%93%E7%BC%93%E5%AD%98" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%B9%92%E4%B9%93%E7%BC%93%E5%AD%98" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>乒乓操作是FPGA 中处理数据流控制的一种存储技术。输入数据的数据流被分为两个数据缓冲区，分为两个数据缓存模块，主要常用于FPGA 的双口RAM、单口SRAM 中。具体操作步骤是在第一个缓存周期时，将数据流存放在第一个缓存模块内，在第二个缓存周期时，将输入的数据流存放在第二个缓存模块的同时把存放在第一个缓存模块的数据发送给后续模块单元进行下一步操作。在第三个缓存周期到来时，再把第二个缓存模块中的数据发送给下一模块的同时，将新进入的数据存放在第一缓存模块中，如此不断循环。这样操作的优势是非常适合于数据流大量且连续不断的流水线结构中，可以在快速处理数据的同时完成数据的无缝缓存处理。乒乓缓存节约缓冲区的空间，使FPGA 资源得到有效的利用。</p>
<p>另一种说法是先把一片存储器数据存满，换第二个存储器存数据，同时通过控制模块读取第一个存储器的数据。</p>
<center>
<img src="./img/图片1.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.乒乓缓存-缓存中的乒乓操作可以保证流水线的持续运行
</font>
</center>


<h3 class="relative group">FIFO寄存器 
    <div id="fifo%E5%AF%84%E5%AD%98%E5%99%A8" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#fifo%E5%AF%84%E5%AD%98%E5%99%A8" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>点击<a href="###FIFO"  >
    此处</a>进行跳转</p>


<h3 class="relative group">Buffer 
    <div id="buffer" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#buffer" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>设计方案：</p>
<ol>
<li><strong>基于寄存器的缓存区：</strong> 这种设计方案使用寄存器作为缓存区的存储单元，具有快速的访问速度和低延迟。寄存器缓存区通常用于存储临时数据或者需要快速访问的数据，例如数据通路中的临时变量或者状态寄存器。</li>
<li><strong>基于存储器的缓存区：</strong> 这种设计方案使用存储器（如RAM、ROM等）作为缓存区的存储单元，可以存储大量的数据并支持随机访问。存储器缓存区通常用于存储数据或者程序代码，例如计算机系统中的主存储器。</li>
<li><strong>基于队列的缓存区（FIFO）：</strong> 这种设计方案使用 FIFO（First-In-First-Out）队列作为缓存区的存储结构，数据按照先进先出的顺序进行存储和读取。FIFO 缓存区通常用于数据传输或者通信系统中，例如数据缓冲、数据队列等场景。</li>
<li><strong>基于缓存控制器的缓存区：</strong> 这种设计方案使用专门的缓存控制器来管理缓存区的读写操作，实现数据的存储、读取和更新等功能。缓存控制器通常具有较复杂的控制逻辑，可以实现高效的缓存管理策略，例如数据预取、置换算法等。</li>
<li><strong>基于硬件加速器的缓存区：</strong> 这种设计方案使用专用的硬件加速器来实现缓存区的功能，通常采用定制化的硬件设计和优化算法，可以实现高性能的数据存储和访问。硬件加速器缓存区通常用于需要高速数据处理和计算的应用场景，例如数字信号处理、图像处理等领域</li>
</ol>
<p>cache可以看成一种特殊的buffer。</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">数据精度 
    <div id="%E6%95%B0%E6%8D%AE%E7%B2%BE%E5%BA%A6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%95%B0%E6%8D%AE%E7%B2%BE%E5%BA%A6" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>​	浮点数拥有更高的精度和更大的动态范围，常用于软件实现的卷积神经网络中。在FPGA中采用浮点数会消耗大量的资源，因此在资源有限的前提下，为了追求高效计算处理可以选择低精度的定点数。</p>
<p>32位浮点数转换为整型数据</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">AXI 
    <div id="axi" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#axi" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h2 class="relative group">DMA 
    <div id="dma" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#dma" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>DMA 的端口介绍</p>
<p>DMA的读通道（READ channel）：允许从memory，PS DRAM流式传输数据到AXI stream interface。</p>
<p>DMA的写通道（WRITE channel）：从AXI stream接收数据写回到PS DRAM。</p>
<p>读写通道的接口是AXI Master ports，也称作memory-mapped ports。MM2S(Memory-Mapped to Stream)读通道，访问PS memory； S2MM (Stream to Memory-Mapped)写通道。</p>


<h3 class="relative group">control port 
    <div id="control-port" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#control-port" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>AXI lite control port，write instructions to configure, start and stop the DMA, and readback status.</p>


<h3 class="relative group">AXI Masters 
    <div id="axi-masters" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#axi-masters" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>两个AXI Master ports连接到DRAM用于读写内存。M_AXI_MM2S_ (READ channel) and M_AXI_S2MM_ (WRITE channel).</p>
<p>在一些案例中这两个端口被连接到Zynq HP(High Performance) AXI Slave ports.</p>
<p>The width of the HP ports can be changed in the Vivado design, however these ports are configured when PYNQ boots the board. You need to make sure the width of the ports in your Vivado design matches the PYNQ boot settings. In all official PYNQ images, the width of the HP ports is 64-bit.</p>


<h3 class="relative group">AXI Streams 
    <div id="axi-streams" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#axi-streams" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>两个AXI stream ports。</p>
<p>1、与读通道对应的AXI master Stream (M_AXI<strong>S</strong>_MM2S)。数据从内存中读取经过M_AXI_MM2S端口，然后发送到 M_AXIS_MM2S 端口，送往与这个端口相连的IP。</p>
<p>2、AXI Slave (S_AXI<strong>S</strong>_S2MM)，这个端口往往连接到你的IP。DMA通过这个接口接收来自IP的数据，然后通过M_AXI_S2MM port写回到memory。</p>
<p>如果IP还没有准备好接收来自M_AXIS端口的数据，那么这个端口将会停止运行。您也可以使用AXI流fifo。如果IP试图回写数据，但DMA写还没有开始，S_AXIS通道将使IP停止。同样，如果需要，可以使用fifo。DMA有一些内置的缓冲，所以如果您试图调试您的设计，您可能会看到一些(或全部)数据从内存中读取，但它可能不一定已经发送到您的IP，并且可能在内部排队或在HP端口fifo中。</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">pynq-z2 
    <div id="pynq-z2" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#pynq-z2" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>默认ip：http://192.168.2.99，注意与之相连的以太网ip应该为192.168.2.xx</p>
<p>要开启网络共享：网络共享会将以太网的地址修改到192.168.137.1</p>
<p>所以要提前把pynq的ip从192.168.2修改到192.168.137.xx。之后从http://192.168.2.xx来访问pynq。</p>
<p>或者直接用ifconfig命令查看pynq的ip地址，发现有一个正好在192.168.137上。我的是192.168.137.19(v2.6)。</p>
<p>\\192.168.137.19\xilinx 在文件资源管理器中可以用这个直接访问。</p>
<p><a href="https://pynq.readthedocs.io/en/latest/index.html#"   target="_blank">
    https://pynq.readthedocs.io/en/latest/index.html#</a></p>


<h3 class="relative group">ZYNQ7 Processing System 
    <div id="zynq7-processing-system" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#zynq7-processing-system" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<center>
<img src="./img/屏幕截图 2024-04-14 204738.png" width="1000"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>
<p>The PYNQ-Z2 supports MicroSD, Quad SPI Flash, and JTAG boot modes. The boot mode is selected using the Mode jumper (JP1). TO select the boot mode, move the jumper to the appropriate position as indicated by the label on the board.</p>


<h3 class="relative group">Overlay 概念 
    <div id="overlay-%E6%A6%82%E5%BF%B5" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#overlay-%E6%A6%82%E5%BF%B5" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>PYNQ image中包含了PL端的bitstream文件，bitstream 文件包含了在 FPGA（Field-Programmable Gate Array，现场可编程门阵列）上实现的硬件逻辑设计，包括各种 IP 核、逻辑元件和连接等。在 PYNQ 中加载 bitstream 主要通过 <code>Overlay</code> 对象来实现。</p>
<p>1.<strong>导入 Overlay 模块：</strong> 首先在 Python 中导入 <code>Overlay</code> 模块，这个模块包含了加载 bitstream 和访问其中 IP 核的方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
</span></span></code></pre></div><p>2.<strong>实例化 Overlay 对象：</strong> 使用 <code>Overlay</code> 模块中的 <code>Overlay</code> 类实例化一个 Overlay 对象。需要提供 bitstream 文件的路径作为参数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">overlay</span> <span class="o">=</span> <span class="n">Overlay</span><span class="p">(</span><span class="s1">&#39;/path/to/bitstream.bit&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>3.<strong>加载 bitstream：</strong> 使用实例化的 Overlay 对象的 <code>download()</code> 方法加载 bitstream 到 FPGA 上。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">overlay</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
</span></span></code></pre></div><p>加载了 bitstream 之后，其中定义的硬件逻辑才会在 FPGA 的可编程逻辑（PL）中形成具体的电路。这意味着 FPGA 上的可编程逻辑会根据 bitstream 中的描述进行配置和实现，从而形成具体的硬件电路结构。一旦 bitstream 成功加载到 FPGA 上，其中定义的硬件逻辑就会在 FPGA 中运行，并且可以通过软件（如 Python 代码）来与其进行交互。加载 bitstream 的过程实际上是将 bitstream 文件中的配置数据加载到 FPGA 的配置存储单元中，并根据这些数据配置 FPGA 中的可编程逻辑资源，从而实现其中定义的硬件功能和连接。</p>


<h3 class="relative group">PS-PL数据交互 
    <div id="ps-pl%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ps-pl%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h4 class="relative group">PS-PL Communication 
    <div id="ps-pl-communication" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ps-pl-communication" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>在 Zynq 系列的处理器中，AXI（Advanced eXtensible Interface）总线有不同类型的从设备接口，包括 HP slave AXI、GP slave AXI 和 ACP slave AXI。它们之间的区别主要体现在其连接到的总线、性能和特性上：</p>
<ol>
<li>
<p><strong>HP（High Performance）Slave AXI：</strong></p>
<ul>
<li>HP slave AXI 连接到 Zynq 处理器的高性能（High Performance）总线。</li>
<li>这个接口提供了更高的带宽和低延迟，适合于连接对性能要求较高的设备或模块，例如外部高速存储器、高性能的外设等。</li>
</ul>
</li>
<li>
<p><strong>GP（General Purpose）Slave AXI：</strong></p>
<ul>
<li>GP slave AXI 连接到 Zynq 处理器的通用（General Purpose）总线。</li>
<li>这个接口的性能通常比 HP 接口低一些，但它更加灵活，适用于连接对性能要求不那么高的设备或模块，例如外部低速外设、控制器等。</li>
</ul>
</li>
<li>
<p><strong>ACP（Accelerator Coherency Port）Slave AXI：</strong></p>
<ul>
<li>ACP slave AXI 连接到 Zynq 处理器的加速器一致性（ACP）端口。</li>
<li>这个接口设计用于连接加速器或其他具有一致性需求的设备。与其他 AXI 接口不同，ACP 接口具有<a href="###%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7%e6%9c%ba%e5%88%b6"  >
    缓存一致性机制</a>，可以提供更高的性能和可靠性，适用于需要与处理器进行缓存一致性交互的设备。</li>
</ul>
</li>
</ol>
<p>总的来说，HP slave AXI、GP slave AXI 和 ACP slave AXI 分别适用于不同的场景和设备，并且在性能、带宽和一致性等方面有所差异。选择适合的接口类型取决于具体的系统架构、性能需求和设备特性。</p>
<p><a href="https://blog.csdn.net/qq_42826337/article/details/103239294?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=pynq%E7%9A%84ps%E7%AB%AF%E4%B8%8Epl%E7%AB%AF%E9%80%9A%E4%BF%A1&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-103239294.142%5ev100%5econtrol&amp;spm=1018.2226.3001.4187"   target="_blank">
    https://blog.csdn.net/qq_42826337/article/details/103239294?ops_request_misc=&request_id=&biz_id=102&utm_term=pynq%E7%9A%84ps%E7%AB%AF%E4%B8%8Epl%E7%AB%AF%E9%80%9A%E4%BF%A1&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-103239294.142^v100^control&spm=1018.2226.3001.4187</a></p>


<h3 class="relative group">基于BRAM的PS与PL数据交互 
    <div id="%E5%9F%BA%E4%BA%8Ebram%E7%9A%84ps%E4%B8%8Epl%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%9F%BA%E4%BA%8Ebram%E7%9A%84ps%E4%B8%8Epl%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<center>
<img src="./img/屏幕截图 2024-04-16 124328.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.
</font>
</center>
<p><a href="https://www.zhihu.com/column/c_1694496932997840897"   target="_blank">
    https://www.zhihu.com/column/c_1694496932997840897</a></p>
<p><a href="https://blog.csdn.net/weixin_44852755/article/details/134223729"   target="_blank">
    https://blog.csdn.net/weixin_44852755/article/details/134223729</a></p>
<p><a href="https://openatomworkshop.csdn.net/6604eb7e1a836825ed7a32c7.html?dp_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MzEwNDY3MiwiZXhwIjoxNzEzODUwMTgyLCJpYXQiOjE3MTMyNDUzODIsInVzZXJuYW1lIjoid2VpeGluXzQ0ODE3NzkyIn0.Cy56djbycG37y_essvRQV1j8ATxWQ0P-8l61HhD9M90"   target="_blank">
    https://openatomworkshop.csdn.net/6604eb7e1a836825ed7a32c7.html?dp_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MzEwNDY3MiwiZXhwIjoxNzEzODUwMTgyLCJpYXQiOjE3MTMyNDUzODIsInVzZXJuYW1lIjoid2VpeGluXzQ0ODE3NzkyIn0.Cy56djbycG37y_essvRQV1j8ATxWQ0P-8l61HhD9M90</a></p>
<p>在 PYNQ-Z2 开发板上，PS（Processing System，即 ARM 处理系统）可以通过 AXI 接口与 PL（Programmable Logic，即可编程逻辑）进行通信。要实现 PS 端读取 PL 端的 BRAM，可以按照以下步骤进行：</p>
<ol>
<li>在 Vivado 中设计并实现包含 BRAM 的 PL 逻辑，并在 Block Design 中将 AXI BRAM Controller IP 实例化，以便 PS 可以通过 AXI 接口访问 BRAM。</li>
<li>将完成的设计生成 bitstream 文件，并将其加载到 PYNQ-Z2 开发板上。</li>
<li>在 PYNQ-Z2 的 Jupyter Notebook 环境中，通过 Python 代码访问 PS 端与 PL 端连接的 AXI 总线，以读取 BRAM 中的数据。</li>
</ol>
<p>以下是一个简单的 Python 示例代码，用于在 PYNQ-Z2 上读取 PL 端的 BRAM 数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pythonCopy</span> <span class="n">codefrom</span> <span class="n">pynq</span> <span class="kn">import</span> <span class="nn">Overlay</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加载 bitstream 文件</span>
</span></span><span class="line"><span class="cl"><span class="n">overlay</span> <span class="o">=</span> <span class="n">Overlay</span><span class="p">(</span><span class="s1">&#39;path_to_bitstream.bit&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取 BRAM 对象</span>
</span></span><span class="line"><span class="cl"><span class="n">bram</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">.</span><span class="n">axi_bram_0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义读取函数</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_bram</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">bram</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 读取 BRAM 数据</span>
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># BRAM 起始地址</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">read_bram</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;BRAM 数据：&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span></code></pre></div><p>这个示例假设了在 PYNQ-Z2 上加载了名为 <code>path_to_bitstream.bit</code> 的 bitstream 文件，并且 BRAM 控制器在 Overlay 中被命名为 <code>axi_bram_0</code>。<code>read_bram()</code> 函数用于从 BRAM 中读取数据，你可以根据实际的地址范围和数据类型进行调整。</p>
<p><a href="https://blog.csdn.net/weixin_44441367/article/details/107700264?spm=1001.2101.3001.6650.3&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-107700264-blog-104811349.235%5Ev43%5Epc_blog_bottom_relevance_base1&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-107700264-blog-104811349.235%5Ev43%5Epc_blog_bottom_relevance_base1&amp;utm_relevant_index=6"   target="_blank">
    https://blog.csdn.net/weixin_44441367/article/details/107700264?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-107700264-blog-104811349.235%5Ev43%5Epc_blog_bottom_relevance_base1&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-107700264-blog-104811349.235%5Ev43%5Epc_blog_bottom_relevance_base1&utm_relevant_index=6</a></p>


<h3 class="relative group">基于DMA的PS与PL数据交互 
    <div id="%E5%9F%BA%E4%BA%8Edma%E7%9A%84ps%E4%B8%8Epl%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%9F%BA%E4%BA%8Edma%E7%9A%84ps%E4%B8%8Epl%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h3 class="relative group">AXI总线 
    <div id="axi%E6%80%BB%E7%BA%BF" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#axi%E6%80%BB%E7%BA%BF" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>PS端与PL端的信息交互通过AXI(Advanced eXtensible Interface,高级可拓展接口)总线实现。由ARM公司提出的一种片内总线协议</p>


<h3 class="relative group">缓存一致性机制 
    <div id="%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%9C%BA%E5%88%B6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%9C%BA%E5%88%B6" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>缓存一致性机制是一种用于确保多个处理器核心或者处理器核心与外设之间的数据一致性的机制。在具有多级缓存的系统中，当数据被修改时，可能会导致缓存中的数据与内存中的数据不一致。为了解决这个问题，引入了缓存一致性机制。</p>
<p>在基于缓存一致性的系统中，当某个处理器核心修改了内存中的数据时，会发送一条信号或者通知到其他处理器核心或者与之连接的外设，通知它们相应的缓存中的数据已经失效或者过期。这样，在其他处理器核心或者外设读取相应数据时，会从内存重新获取最新的数据，保证了数据的一致性。</p>
<p>在 Zynq 系列的处理器中，ACP（Accelerator Coherency Port）是提供了缓存一致性机制的接口，可以保证处理器核心与外设之间的数据一致性。通过 ACP 接口连接的外设可以与处理器的缓存系统进行协同工作，确保数据的一致性和正确性，提高了系统的性能和可靠性。</p>
<p><a href="https://discuss.pynq.io/t/tutorial-creating-a-hardware-design-for-pynq/145"   target="_blank">
    Tutorial: Creating a hardware design for PYNQ</a>
<a href="https://discuss.pynq.io/t/tutorial-using-a-new-hardware-design-with-pynq-axi-gpio/146"   target="_blank">
    Tutorial: Using a new hardware design with PYNQ (AXI GPIO)</a>
<a href="https://discuss.pynq.io/t/tutorial-rebuilding-the-pynq-base-overlay-pynq-v2-6/1993"   target="_blank">
    Tutorial: Rebuilding the PYNQ base overlay (PYNQ v2.6)</a>
<a href="https://discuss.pynq.io/t/tutorial-pynq-dma-part-1-hardware-design/3133"   target="_blank">
    Tutorial: PYNQ DMA (Part 1: Hardware design)</a>
<a href="https://discuss.pynq.io/t/tutorial-pynq-dma-part-2-using-the-dma-from-pynq/3134"   target="_blank">
    Tutorial: PYNQ DMA (Part 2: Using the DMA from PYNQ)</a>
<a href="https://discuss.pynq.io/t/tutorial-using-a-hls-stream-ip-with-dma-part-1-hls-design/3344"   target="_blank">
    Tutorial: using a HLS stream IP with DMA (Part 1: HLS design)</a>
<a href="https://discuss.pynq.io/t/tutorial-using-a-hls-stream-ip-with-dma-part-2-vivado-design/3345"   target="_blank">
    Tutorial: using a HLS stream IP with DMA (Part 2: Vivado design)</a>
<a href="https://discuss.pynq.io/t/tutorial-using-a-hls-stream-ip-with-dma-part-3-using-the-hls-ip-from-pynq/3346"   target="_blank">
    Tutorial: using a HLS stream IP with DMA (Part 3: Using the HLS IP from PYNQ)</a></p>
<p><a href="https://www.youtube.com/watch?v=qNQ3Q2GrIYg"   target="_blank">
    ZYNQ Training - session 03 - axi stream interface</a></p>


<h3 class="relative group"><a href="https://www.fpgadeveloper.com/2014/08/creating-a-custom-ip-block-in-vivado.html/"   target="_blank">
    Creating a custom IP block in Vivado</a> 
    <div id="creating-a-custom-ip-block-in-vivadohttpswwwfpgadevelopercom201408creating-a-custom-ip-block-in-vivadohtml" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#creating-a-custom-ip-block-in-vivadohttpswwwfpgadevelopercom201408creating-a-custom-ip-block-in-vivadohtml" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<div style="page-break-after:always"></div>


<h2 class="relative group">卷积神经网络的部署 
    <div id="%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E9%83%A8%E7%BD%B2" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E9%83%A8%E7%BD%B2" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>神经网络的部署并不简单，不同深度学习框架对各个算子的描述存在差异，各类计算平台的架构和指令集都不相同。</p>
<hr>
<p>实时性：</p>
<p>1、FPGA内嵌DDR的带宽和访问速度。</p>
<p>2、FPGA内部计算模块的并行性。</p>
<p>需要分析卷积模块在每个有效时钟周期内能够处理卷积操作能力。当卷积模块读取输入图像像素个数的时间等于卷积操作所需要的时间时，系统的效率最高。</p>
<p>数据原图、系数以及偏移量等输入数据首先从外部存储器读取到内部的数据缓冲区中，并且在模块间加入临时数据寄存器，使得数据输出模块后直接进入下一模块，从而进一步减少对DDR 的访问次数，降低功耗。</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">论文 
    <div id="%E8%AE%BA%E6%96%87" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E8%AE%BA%E6%96%87" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h3 class="relative group"><em>FPGA Implementation of processing element unit in CNN accelerator using Modified Booth Multiplier and Wallace Tree Adder on UniWiG Architecture</em>（2022） 
    <div id="fpga-implementation-of-processing-element-unit-in-cnn-accelerator-using-modified-booth-multiplier-and-wallace-tree-adder-on-uniwig-architecture2022" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#fpga-implementation-of-processing-element-unit-in-cnn-accelerator-using-modified-booth-multiplier-and-wallace-tree-adder-on-uniwig-architecture2022" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<blockquote>
<p>Thomas, Bless and Manju Manuel. “FPGA Implementation of processing element unit in CNN accelerator using Modified Booth Multiplier and Wallace Tree Adder on UniWiG Architecture.” <em>2022 IEEE International Power and Renewable Energy Conference (IPRECON)</em> (2022): 1-5.</p>
</blockquote>
<p>处理单元PE(Processing Element)执行卷积运算。在这篇论文中，作者使用 MBE(Modified Booth Encoding multiplier)、Wallace tree adders 设计了新的PE。减少了硬件资源和功率的消耗。将改进的PE单元引入到UniWiG(Unified Winograd GEMM architecture)架构上(用改进的PE单元替换传统的PE单元，传统的PE单元中主要是MAC单元和加法树)，相比于之前的设计能够减少硬件复杂度和功耗。本文的硬件采用verilog实现，并在FPGA板上测试。</p>
<center>
<img src="./img/屏幕截图 2024-03-27 122600.png" width="500"/>
</center>
<center>
<font size=2 >
Fig.Processing elements unit for Convolution
</font>
</center>
<center>
<img src="./img/image-20240327090757554.png" width="800"/>
</center>
<center>
<font size=2 >
Fig. Modified PE unit using MBE multiplier and wallace adder
</font>
</center>
<p>相乘运算包含3个主要步骤：编码和部分积、通过某种策略减少pps、用CPA将待处理的行相加得到结果。</p>
<p>设计采用Verilog HDL实现，并部署在Artix7(xc7a35tcpg236) FPGA开发板上。与其他文献中的结果进行对比，这项工作降低了查找表、flip flop的占用。</p>
<hr>
<div style="page-break-after:always"></div>


<h3 class="relative group">Power Efficient Tiny Yolo CNN Using Reduced Hardware Resources Based on Booth Multiplier and WALLACE Tree Adders（2020） 
    <div id="power-efficient-tiny-yolo-cnn-using-reduced-hardware-resources-based-on-booth-multiplier-and-wallace-tree-adders2020" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#power-efficient-tiny-yolo-cnn-using-reduced-hardware-resources-based-on-booth-multiplier-and-wallace-tree-adders2020" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<blockquote>
<p>F. U. D. Farrukh et al., &ldquo;Power Efficient Tiny Yolo CNN Using Reduced Hardware Resources Based on Booth Multiplier and WALLACE Tree Adders,&rdquo; in IEEE Open Journal of Circuits and Systems, vol. 1, pp. 76-87, 2020, doi: 10.1109/OJCAS.2020.3007334.
keywords: {Field programmable gate arrays;Convolution;Hardware;Adders;System-on-chip;Kernel;Task analysis;Convolutional neural network;booth encoding multiplier;WALLACE tree adders;FPGA;adder tree;object detection},</p>
</blockquote>
<p>加速器设计的一个关键步骤是实现卷积操作的处理元素PE。本文提出了新的PE设计MBE乘法器和基于华莱士树的加法器来替代MAC单元以及典型的加法树。所提出的架构在目标检测任务上进行测试，在zynq-706上进行了部署，在Tiny-YOLO-v2架构下实现87.03GOP/s的吞吐量，硬件成本降低了24.5%，功率效率61.64GOP/s/W。优于以往的设计。</p>
<p>时分多路串行化技术和近似计算技术被应用到多操作加法器（MOAs）但是没能取得预期的效果。</p>
<p>WALLACE tree adders提供了另一种关于MOAs的解决方案。</p>


<h4 class="relative group">系统架构及其概述 
    <div id="%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E6%A6%82%E8%BF%B0" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E6%A6%82%E8%BF%B0" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<center>
<img src="./img/屏幕截图 2024-03-27 213220.png" width="1000"/>
</center>
<center>
<font size=2 >
Fig. System Architecture.
</font>
</center>
#### PE-Processing Element
<p>本研究针对计算引擎中的PE单元进行优化。</p>
<center>
<img src="./img/屏幕截图 2024-03-27 222526.png" width="500"/>
</center>
<center>
<font size=2 >
Fig. The Pseudocode for a Convolutional Layer.
</font>
</center>
<p>循环交换（loop interchange）决定了四个循环的计算顺序。有两种循环交换技术inter-tile（层间）和intra-tile（层内）。inter-tile loop order 决定了数据如何从片外内存向片上内存移动；intra-tile决定数据如何从片上内存移动到PEs。本文的加速器伪代码如下所示：</p>
<center>
<img src="./img/屏幕截图 2024-03-27 224955.png" width="500"/>
</center>
<center>
<font size=2 >
Fig. The Pseudocode for a Proposed Accelerator Design.
</font>
</center>
使用上面的伪代码生成的硬件如下图所示：
<center>
<img src="./img/屏幕截图 2024-03-28 083539.png" width="400"/>
</center>
<center>
<font size=2 >
Fig. The computation engine of CNN..
</font>
</center>
<p>输入特征图采用了数据重用，内核权重在线更新。由于硬件资源限制，Tm，Tn取为16。为了对Tm循环展开，重复了16个poly structure，即共有16个PE（processing element）。PE结构如下图所示，在每个PE中使用了16个乘法器和15个加法器来进行卷积运算。</p>
<center>
<img src="./img/屏幕截图 2024-03-28 090315.png" width="450"/>
</center>
<center>
<font size=2 >
Fig. Hardware mapping of processing element for convolution layers.
</font>
</center>
为了剑招硬件资源消耗数量并提高系统的能量效率。在此设计中乘法器用MBE（modified booth encoding）算法替代。typical binary adder tree用WALLACE tree-based adders代替。


<h4 class="relative group">memory organization 
    <div id="memory-organization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#memory-organization" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>内存结构需要根据输入特征图、输出特征图的大小，内核的权值数量来确定。卷积运算需要频繁切换不同的输入特征和卷积核，这就造成了很大的数据访问压力。为了降低从外部存储器访问数据的成本，增加数据重用，并调整相邻内存层次结构级别之间的数据流，应用循环展开、循环平铺和循环交换来定制具有三级内存层次结构的加速器的计算和通信模式。因此，可以同时用于片上计算的计算单元的数量大大增加，其代价是每次只增加存储在片上的数据量。</p>
<p>在FPGA中，block RAM（BRAM）有单端口或双端口，在一个时钟周期内可以访问一个值。在我们提出的系统中设计使用了多维存储器来方便同时访问多个数据。下图显示了存储层次结构，它由输入缓冲区、输出缓冲区、权值缓冲区组成。每个buffer set包含独立的buffer banks。输入buffer banks的数量等于Tn，输出buffer banks的数量等于Tm。权值buffer每组包含一组多个存储器，数据按照需要执行的计算进行排列。输入、输出buffer使用了Ping-Pong memory mode。</p>
<center>
<img src="./img/屏幕截图 2024-03-28 145653.png" width="550"/>
</center>
<center>
<font size=2 >
Fig. On-chip memory organization (Tn = Tm = 16).
</font>
</center>
<p>cnn加速器的数据流和并行结构的设计如下图所示。</p>
<center>
<img src="./img/屏幕截图 2024-03-28 150757.png" width="750"/>
</center>
<center>
<font size=2 >
Fig. The parallel structure of proposed CNN accelerator design and a PE unit.
</font>
</center>
<p>在PE单元上实现了三级流水线来优化计算顺序。</p>


<h4 class="relative group">激活函数和池化层 
    <div id="%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0%E5%92%8C%E6%B1%A0%E5%8C%96%E5%B1%82" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0%E5%92%8C%E6%B1%A0%E5%8C%96%E5%B1%82" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>激活函数在例如sigmoid、Tang，etc，在池化之前作用，其目的是引入非线性。在我们的加速器设计中使用了Leaky ReLU，他的作用是可以在训练时保护神经元，避免死亡。</p>
<p>池化用于减少特征图的维度，减少神经网络的计算量，同时抛下不重要的信息。在所提出的设计中使用了最大池化。</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">MBE - modified booth multiplier 
    <div id="mbe---modified-booth-multiplier" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#mbe---modified-booth-multiplier" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<div style="page-break-after:always"></div>


<h2 class="relative group">Compressor 
    <div id="compressor" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#compressor" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>压缩器(Compressor)是用于大位数乘法运算中的一种逻辑电路。它的作用是将多个部分积(Partial Products)压缩成较少的部分积,从而降低后续加法器的计算压力。</p>
<p>具体来说,n位乘以m位会产生n+m个部分积。压缩器可以将几个(通常3个或4个)部分积合并成较少的部分积(通常2个或1个)。例如:</p>
<ul>
<li>3:2压缩器将3个部分积合并成2个</li>
<li>4:2压缩器将4个部分积合并成2个</li>
</ul>
<p>通过层层压缩,最终可以将所有部分积压缩至两个最终部分积,再由最后一级加法器相加得到乘积结果。</p>
<p>压缩器广泛应用于大位数乘法器的设计中,包括著名的瓦莱斯树(Wallace Tree)乘法器。使用压缩器可以有效减少中间的部分积条数,缩短关键路径,从而提高硬件乘法器的运算速度和效率。</p>
<p>不同类型的压缩器在面积、延迟、功耗等方面有不同的权衡,需要根据具体设计目标和约束条件选择合适的压缩器结构。压缩器的优化设计是提升乘法器性能的关键技术之一。</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">CAP（Carry Spread Adder） 
    <div id="capcarry-spread-adder" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#capcarry-spread-adder" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<hr>
<hr>
<div style="page-break-after:always"></div>


<h2 class="relative group">NVDLA 
    <div id="nvdla" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#nvdla" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>NVIDIA Deep Learning Accelerator (NVDLA)提供一种设计深度学习推理加速器的标准方法。</p>


<h2 class="relative group">TVM 
    <div id="tvm" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tvm" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>TVM 是一个开源的端到端深度学习编译栈,全称为&quot;TVM: An Automated End-to-End Optimizing Compiler for Deep Learning&quot;。它主要用于优化和加速深度学习模型在各种硬件平台上的部署。</p>
<p><a href="https://github.com/apache/tvm"   target="_blank">
    https://github.com/apache/tvm</a></p>
<p>TVM 的主要特点和作用包括:</p>
<ol>
<li>硬件无关性 TVM 可以优化深度学习模型,使其能够高效地运行在不同硬件平台上,包括 CPU、GPU、FPGA、专用加速器等。开发人员只需编写一次模型,即可针对不同硬件平台进行优化部署。</li>
<li>自动张量程序优化 TVM 采用自动化的方法对张量计算程序进行优化,包括算子融合、数据布局转换、并行计算等优化技术,以获得高性能的模型执行代码。</li>
<li>定制化硬件支持 TVM 可以基于特定硬件的特性进行定制化的优化,如利用 GPU 的张量核心进行加速、利用 FPGA 的并行计算资源等。</li>
<li>模型支持广泛 TVM 支持多种流行的深度学习框架,如 PyTorch、TensorFlow、MXNet等,可以将这些框架下的模型加载并进行优化部署。</li>
<li>部署友好 TVM 生成的优化代码可以方便地集成到各种应用程序中,支持多种编程语言如 C++、Python 等。</li>
</ol>
<p>TVM 主要由美国加州大学伯克利分校和华盛顿大学西雅图分校的研究人员共同开发。它已在工业界和学术界得到广泛应用,成为深度学习模型高效部署的重要工具。</p>


<h2 class="relative group">VTA 
    <div id="vta" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vta" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>VTA(Versatile Tensor Accelerator)是一种模块化和可扩展的FPGA加速器架构,专门设计用于加速深度学习推理任务。它是TVM(Tensor Virtual Machine)项目的一个子项目,由清华大学、华盛顿大学和OctoML公司等联合提出和开发。https://github.com/apache/tvm-vta</p>
<p>VTA架构的主要特点包括:</p>
<ol>
<li>模块化设计 VTA由多个编码器、解码器和张量运算单元组成,这些单元可以根据需求灵活组合,支持不同规模的深度学习模型推理。</li>
<li>指令级并行 VTA采用了指令级并行(ILP)的思想,允许多个不同的指令在同一个周期内同时执行,从而提高了吞吐量。</li>
<li>支持多种数据精度 VTA支持4-bit、8-bit和16-bit等多种数据精度格式,可以权衡计算精度和性能。</li>
<li>层次化内存架构 VTA包含了层次化的内存系统,如寄存器文件、主存储等,用于高效地访问和复用数据。</li>
<li>与TVM紧密集成 VTA作为TVM的加速器后端,可以被TVM编译栈高效地调度和优化,为部署深度学习模型提供了端到端的支持。</li>
</ol>
<p>VTA架构的设计目标是在FPGA等可重配置硬件上高效部署深度学习模型,并具有良好的灵活性和可扩展性。通过VTA,深度学习推理任务可以获得比通用CPU和GPU更高的能效和性能加速比。同时VTA作为开源项目,也为FPGA加速器研究提供了一个很好的基础框架。</p>


<h2 class="relative group">FINN 
    <div id="finn" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#finn" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p><a href="https://xilinx.github.io/finn/"   target="_blank">
    https://xilinx.github.io/finn/</a></p>
<p><a href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/overview?homepageId=18844350"   target="_blank">
    https://xilinx-wiki.atlassian.net/wiki/spaces/A/overview?homepageId=18844350</a></p>
<p>参考资料：</p>
<p><a href="https://github.com/nvdla/hw"   target="_blank">
    Github地址</a>，<a href="http://nvdla.org/"   target="_blank">
    项目网页</a></p>
<div style="page-break-after:always"></div>


<h2 class="relative group">loop unrolling 
    <div id="loop-unrolling" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#loop-unrolling" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<div style="page-break-after:always"></div>


<h2 class="relative group">性能评价指标 
    <div id="%E6%80%A7%E8%83%BD%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%80%A7%E8%83%BD%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>用于科学地评估和比较硬件加速器设计地几种常见地硬件指标：吞吐率、帧率、功率效率、能量效率<sup>[10]</sup>。</p>


<h3 class="relative group">吞吐率 Throughput 
    <div id="%E5%90%9E%E5%90%90%E7%8E%87-throughput" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%90%9E%E5%90%90%E7%8E%87-throughput" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>吞吐率是用来评价算力的通用指标，单位是GOPS或TOPS，表示硬件加速器每秒执行的乘加和的总计算量。具体细分为峰值吞吐率和有效吞吐率</p>


<h3 class="relative group">帧率 
    <div id="%E5%B8%A7%E7%8E%87" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%B8%A7%E7%8E%87" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>加速器每秒推理地图片数量，帧率与加速器的吞吐率和输入图片的尺寸有关。</p>


<h3 class="relative group">功率效率 
    <div id="%E5%8A%9F%E7%8E%87%E6%95%88%E7%8E%87" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%8A%9F%E7%8E%87%E6%95%88%E7%8E%87" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>也被称为能效指标，是加速器设计的主要驱动指标之一，单位是GOPS/W。表示每瓦特的能量消耗下完成的计算量。
$$
Power Efficiency = \frac{\frac{Operations}{execution_time}}{Power}=\frac{\frac{Operations}{execution_time}}{\frac{Energy}{execution_time}}
$$</p>


<h3 class="relative group">能量效率 
    <div id="%E8%83%BD%E9%87%8F%E6%95%88%E7%8E%87" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E8%83%BD%E9%87%8F%E6%95%88%E7%8E%87" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>指加速器完成一张图片推理任务所消耗的能量。除了与硬件设计和网络规模有关外，还与输入图片的尺寸有关。为了获得更客观的对比，有些研究者采用平均推理每个像素所消耗的能量来表示能量效率。</p>


<h2 class="relative group">实验 
    <div id="%E5%AE%9E%E9%AA%8C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%AE%9E%E9%AA%8C" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<div style="page-break-after:always"></div>


<h2 class="relative group">Verilog HDL代码自动生成 
    <div id="verilog-hdl%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#verilog-hdl%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>基于模板的代码自动生成技术</p>
<div style="page-break-after:always"></div>


<h2 class="relative group">参考文献 
    <div id="%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>[1].Sze V, Chen Y H, Yang T J, et al. Efficient processing of deep neural networks: A tutorial and survey[J]. Proceedings of the IEEE, 2017, 105(12): 2295-2329.</p>
<p>[2].田景旭.基于FPGA的卷积神经网络加速器软硬件协同设计[D].哈尔滨理工大学,2023.DOI:10.27063/d.cnki.ghlgu.2023.001107.</p>
<p>[3].黄聚永,袁慧梅,吴向阳,等.基于查找表和Newton 插值算法的正余弦函数的FPGA 实现[J].电力系统保护与控制,2007,35(16):33-36.</p>
<p>[4].王少军,张启荣,彭宇,等.超越函数FPGA 计算的最佳等距分段线性逼近方法[J].仪器仪表学报,2014,35(6):1209-1216.</p>
<p>[5].陆斌斌,孙震.基于泰勒级数线性插值的DDFS 研究[J].电子测量技术,2008,31(10):21-23.</p>
<p>[6].唐文明,刘桂雄.指数函数CORDIC 算法的FPGA 定点化技术[J].华南理工大学学报(自然科学版)2016,44(7):9-14.</p>
<p>[7].徐祥,蒋哲,王威廉.基于FPGA的高速数据采集、缓存与处理系统[J].电子测量技术,2013(４）：６８－７１．</p>
<p>[8].杨会建， 田成军， 杨志娟，等． 基于ＦＰＧＡ 的Ｓ ＤＲＡＭ 乒乓读写操作设计［Ｊ］．长春理工大学学报（ 自然科学版），２０１５（２）：６７－７１．</p>
<p>[9].黄忠朝， 赵于前．一种实现高速异步ＦＩＦ Ｏ 的ＦＰＧＡ 方法［Ｊ］．计算机工程与应用，２０１０,４６（３）：１３－１５．</p>
<p>[10].孙正茂.低功耗人脸检测硬件加速器设计[D].东南大学,2022.DOI:10.27014/d.cnki.gdnau.2022.001653.</p>


<h2 class="relative group">附录 
    <div id="%E9%99%84%E5%BD%95" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%99%84%E5%BD%95" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h3 class="relative group">Verilog Tutorial 
    <div id="verilog-tutorial" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#verilog-tutorial" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p><a href="https://www.asic-world.com/verilog/veritut.html"   target="_blank">
    https://www.asic-world.com/verilog/veritut.html</a></p>


<h3 class="relative group">高级综合工具与硬件描述语言 
    <div id="%E9%AB%98%E7%BA%A7%E7%BB%BC%E5%90%88%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%A1%AC%E4%BB%B6%E6%8F%8F%E8%BF%B0%E8%AF%AD%E8%A8%80" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%AB%98%E7%BA%A7%E7%BB%BC%E5%90%88%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%A1%AC%E4%BB%B6%E6%8F%8F%E8%BF%B0%E8%AF%AD%E8%A8%80" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h3 class="relative group">HLS(Heigh Level Synthsis) 
    <div id="hlsheigh-level-synthsis" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#hlsheigh-level-synthsis" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h3 class="relative group">OpenCL(Open Computing Language) 
    <div id="openclopen-computing-language" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#openclopen-computing-language" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h2 class="relative group">Numpy数组 
    <div id="numpy%E6%95%B0%E7%BB%84" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#numpy%E6%95%B0%E7%BB%84" aria-label="Anchor">#</a>
    </span>        
    
</h2>


<h3 class="relative group">二进制搜索逼近寄存器(Binary Search Successive Approximation Register, SAR) 
    <div id="%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%90%9C%E7%B4%A2%E9%80%BC%E8%BF%91%E5%AF%84%E5%AD%98%E5%99%A8binary-search-successive-approximation-register-sar" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%90%9C%E7%B4%A2%E9%80%BC%E8%BF%91%E5%AF%84%E5%AD%98%E5%99%A8binary-search-successive-approximation-register-sar" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>二进制搜索逼近寄存器(Binary Search Successive Approximation Register, SAR)是一种常用于模数转换器(ADC)和数模转换器(DAC)中的逻辑电路。它的工作原理是通过反复逼近的方式,对模拟量进行高效的数字化或者反数字化。</p>
<p><strong>SAR逻辑的原理:</strong></p>
<ol>
<li>
<p>初始化:首先将最高有效位(MSB)设置为1,其余位清零。这将数字量初始化为量程的一半。</p>
</li>
<li>
<p>比较:将初始数字量转换为模拟量,与被转换的模拟输入信号进行比较。</p>
</li>
<li>
<p>逼近:如果数字量小于模拟量,则保持MSB为1,否则将MSB清零。然后将注意力转移到下一个较低位。</p>
</li>
<li>
<p>重复:重复步骤2和3,直到检查完所有位,从而确定表示模拟量的最佳数字逼近值。</p>
</li>
<li>
<p>转换结果:最终的数字量就是模数转换(ADC)或数模转换(DAC)的结果。</p>
</li>
</ol>
<p>SAR逻辑的优点是简单、收敛速度快、面积和功耗较低。它使用了二分搜索的思想,逐步逼近被转换模拟量,效率较高。因此SAR广泛应用于各种模数转换器中。</p>
<p><strong>SAR逻辑的应用:</strong></p>
<ol>
<li>
<p>SAR ADC
利用SAR逻辑可以实现快速、省功耗的模数转换器电路,常用于测量、数据采集等需要中等分辨率和速度的应用场景。</p>
</li>
<li>
<p>SAR DAC
基于SAR的数模转换器电路可以快速从数字码产生相应的模拟量,常用于波形生成、信号重构等领域。</p>
</li>
<li>
<p>传感器信号调理
SAR ADC可用于各种传感器的模拟信号采集,如测温、测压等。辅以μC可实现智能传感系统。</p>
</li>
<li>
<p>音频处理
在音频应用中,SAR ADC/DAC可用于音频数字化、音频解码等。</p>
</li>
<li>
<p>精密测量
搭配altre、电容阵列等部件,SAR ADC可实现高分辨率、高精度的测量应用。</p>
</li>
</ol>
<p>SAR逻辑的发展主要体现在提高转换速度、降低功耗、提高分辨率、抗干扰能力等方面的改进和工艺进步。总体来说,SAR逻辑凭借简单、高效的特点,在多个领域的模数转换应用中发挥着重要作用。</p>


<h2 class="relative group">秋招 
    <div id="%E7%A7%8B%E6%8B%9B" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%A7%8B%E6%8B%9B" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p><a href="https://blog.csdn.net/lum250/article/details/128585247?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171293039916800184165442%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=171293039916800184165442&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-4-128585247-null-null.142%5ev100%5econtrol&amp;utm_term=%E6%95%B0%E5%AD%97ic%E8%AE%BE%E8%AE%A1%E7%AE%80%E5%8E%86&amp;spm=1018.2226.3001.4187"   target="_blank">
    https://blog.csdn.net/lum250/article/details/128585247?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171293039916800184165442%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=171293039916800184165442&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-4-128585247-null-null.142^v100^control&utm_term=%E6%95%B0%E5%AD%97ic%E8%AE%BE%E8%AE%A1%E7%AE%80%E5%8E%86&spm=1018.2226.3001.4187</a></p>


<h2 class="relative group">八股： 
    <div id="%E5%85%AB%E8%82%A1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%85%AB%E8%82%A1" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUyNTc4NTk0OA==&amp;mid=2247519512&amp;idx=1&amp;sn=eec2969b32c72b43da6fba8252b20539&amp;chksm=fa1a032bcd6d8a3d8db0b1f45952bfec258f998d2535f47e28e4a522e36491823055a4e42787&amp;scene=21#wechat_redirect"   target="_blank">
    https://mp.weixin.qq.com/s?__biz=MzUyNTc4NTk0OA==&mid=2247519512&idx=1&sn=eec2969b32c72b43da6fba8252b20539&chksm=fa1a032bcd6d8a3d8db0b1f45952bfec258f998d2535f47e28e4a522e36491823055a4e42787&scene=21#wechat_redirect</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUyNTc4NTk0OA==&amp;mid=2247521877&amp;idx=7&amp;sn=646ceaa123feea65bcaf7c178ab11185&amp;chksm=fa1a1866cd6d9170321b250f87d73c5f8941ce5bb241982791313e5f147a78237cbfa1a2a580&amp;scene=21#wechat_redirect"   target="_blank">
    https://mp.weixin.qq.com/s?__biz=MzUyNTc4NTk0OA==&mid=2247521877&idx=7&sn=646ceaa123feea65bcaf7c178ab11185&chksm=fa1a1866cd6d9170321b250f87d73c5f8941ce5bb241982791313e5f147a78237cbfa1a2a580&scene=21#wechat_redirect</a></p>
<p><a href="https://blog.csdn.net/qq_21952195/article/details/136490861?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171296997216800215045094%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=171296997216800215045094&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~times_rank-1-136490861-null-null.142%5ev100%5econtrol&amp;utm_term=%E6%95%B0%E5%AD%97ic%E8%AE%BE%E8%AE%A1%E7%AE%80%E5%8E%86&amp;spm=1018.2226.3001.4187"   target="_blank">
    https://blog.csdn.net/qq_21952195/article/details/136490861?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171296997216800215045094%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=171296997216800215045094&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~times_rank-1-136490861-null-null.142^v100^control&utm_term=%E6%95%B0%E5%AD%97ic%E8%AE%BE%E8%AE%A1%E7%AE%80%E5%8E%86&spm=1018.2226.3001.4187</a></p>
<p>使用加法器计算7bit中1的数量，最少要用几个？</p>
<p>关键在于明确1bit的全加器可以将3bits相加，得到两bit结果。答案：4个1bit全加器。</p>
<p>N分频，周期是原始clk的N倍。</p>
<p>怎么实现分数分频？</p>
<p>偶数分频器的实现简单，用计数器在上升沿或者下降沿计数，当计数器的值等于分频系数的一半或等于分频系数时，
信号翻转。</p>
<p>如果不要求占空比为50%的话，也比较容易实现，如进行三分频，通过待分频时钟上升沿触发计数器进行模三计数，当计数器计数到邻近值进行两次翻转，比如可以在计数器计数到1时，输出时钟进行翻转，计数到2时再次进行翻转。即在计数值在邻近的1和2进行了两次翻转。这样实现的三分频占空比为1/3或者2/3。对于实现占空比为50%的N倍奇数分频，可以分解为两个通道：上升沿触发进行模N计数，计数选定到某一个值进行输出时钟翻转，然后经过（N-1）/2再次进行翻转得到一个占空比为非50%奇数N分频时钟；下降沿触发进行模N计数，到和上升沿触发输出时钟翻转选定值相同值时，进行输出时钟时钟翻转，同样经过（N-1）/2时，输出时钟再次翻转生成占空比非50%的奇数N分频时钟。将这两个占空比非50%的N分频时钟或运算，得到占空比为50%的奇数n分频时钟。</p>
<p>或者对于5分频，周期是原来的5倍，一共是10个边沿(包括上升沿和下降沿)，则每间隔5个边沿(上升沿和下降沿)输出信号翻转一次。</p>
<p>对于分数分频 (N = M.D)，其中 (N) 是所需的分频比，(M) 是分频比的整数部分，(D) 是分频比的小数部分。为了实现这个分频比，将 (M) 分频器连续运行 (N_1) 个周期，并且将 (M+1) 分频器连续运行 (N_2) 个周期，这样就可以实现整体的分频比为 (N)。</p>
<p>具体来说，假设 (M) 分频器的周期是 (T)，那么连续运行 (N_1) 次 (M) 分频器相当于经过 $M \times N_1 \times T$ 的时间，(M+1) 分频器运行 (N_2) 次相当于经过 ((M+1) \times N_2 \times T) 的时间。当这两个时间加起来正好等于 (N \times T) 时，就实现了整体的分频比为 (N)。</p>
<p>这种方法通过控制 (M) 分频器和 (M+1) 分频器的工作次数，来间接控制整体的分频比，以实现对时钟信号的精确分频。</p>
<p>当分频比为 (1.5) 时，我们希望将输入时钟信号的频率降低到原来的 (1.5) 倍。这里整数部分 (M = 1)，小数部分 (D = 0.5)。</p>
<p>接下来，我们使用 (M) 和 (M+1) 分频器来实现这个分频比。具体步骤如下：</p>
<ol>
<li>
<p><strong>确定 (M) 和 (M+1) 分频器的工作周期：</strong> 假设输入时钟信号的周期是 (T)，则 (M) 分频器的周期仍然是 (T)，而 (M+1) 分频器的周期是 (T/2)。</p>
</li>
<li>
<p><strong>确定 (M) 和 (M+1) 分频器的工作次数：</strong> 对于 (M) 分频器，我们需要让它连续工作 (1) 个周期，对于 (M+1) 分频器，我们需要让它连续工作 (1) 个周期。</p>
</li>
<li>
<p><strong>计算整体分频比：</strong> 将 (M) 分频器运行 (1) 个周期的时间加上 (M+1) 分频器运行 (1) 个周期的时间，即 (M \times N_1 \times T + (M+1) \times N_2 \times (T/2))。这个时间应当等于 (N \times T)，其中 (N = 1.5)。</p>
</li>
<li>
<p><strong>求解 (N_1) 和 (N_2)：</strong> 代入参数，解方程组，求解 (N_1) 和 (N_2) 的值。</p>
</li>
</ol>
<p>我们可以进行计算：</p>
<p>[
\begin{align*}
&amp; M \times N_1 \times T + (M+1) \times N_2 \times (T/2) = N \times T \
&amp; 1 \times N_1 \times T + 2 \times N_2 \times (T/2) = 1.5 \times T \
&amp; N_1 + N_2 = 1.5
\end{align*}
]</p>
<p>通过求解方程组，我们可以得到 $N_1 = 0.5$ 和$N_2 = 1$。</p>
<p>这样，当 (M) 分频器连续运行 (0.5) 个周期，(M+1) 分频器连续运行 (1) 个周期时，整体的分频比就是 (1.5)。</p>
<center>
<img src="./img/屏幕截图 2024-04-18 210517.png" width="800"/>
</center>
<center>
<font size=2 >
Fig.分数分频的参考结构框图
</font>
</center>


<h2 class="relative group">Blog 
    <div id="blog" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#blog" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p><a href="https://blog.csdn.net/qq_39038178/article/details/125403896?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=node&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-4-125403896.142%5ev100%5econtrol&amp;spm=1018.2226.3001.4187"   target="_blank">
    https://blog.csdn.net/qq_39038178/article/details/125403896?ops_request_misc=&request_id=&biz_id=102&utm_term=node&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-4-125403896.142^v100^control&spm=1018.2226.3001.4187</a></p>
<p><a href="https://blog.csdn.net/weixin_52473454/article/details/131092259?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171370745316800182141303%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=171370745316800182141303&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-131092259-null-null.142%5ev100%5econtrol&amp;utm_term=hugo%20github%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B&amp;spm=1018.2226.3001.4187"   target="_blank">
    https://blog.csdn.net/weixin_52473454/article/details/131092259?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171370745316800182141303%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=171370745316800182141303&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-131092259-null-null.142^v100^control&utm_term=hugo%20github%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B&spm=1018.2226.3001.4187</a></p>
<p><a href="https://themes.gohugo.io/"   target="_blank">
    https://themes.gohugo.io/</a></p>
<p>企业</p>
<p>旷视：https://app.mokahr.com/campus-recruitment/mhr/38642?sourceToken=7567c653697ce23ce687053e5acbba95#/</p>

        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_notebook.md"
        var oid_likes = "likes_notebook.md"
      </script>
      
      
      
      <script type="text/javascript" src="/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js" integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script>
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js" integrity="sha512-YgYLskf03itt3kWQNmj&#43;&#43;2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script>
  
  
</footer><div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://Wboyue.github.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
